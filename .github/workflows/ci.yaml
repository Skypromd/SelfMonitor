name: Monorepo CI

"on":
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
    paths:
      - "services/**"
      - "apps/web-portal/**"
      - "tests/**"
      - ".github/workflows/ci.yaml"

jobs:
  python-services:
    name: Python checks (${{ matrix.service }})
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
    strategy:
      fail-fast: false
      matrix:
        service:
          - agent-service
          - auth-service
          - banking-connector
          - compliance-service
          - consent-service
          - partner-registry
          - tax-engine
          - transactions-service
          - user-profile-service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies for ${{ matrix.service }}
        run: |
          python -m pip install --upgrade pip
          pip install -r services/${{ matrix.service }}/requirements.txt
          pip install flake8 pytest-cov

      - name: Lint with flake8
        working-directory: ./services/${{ matrix.service }}
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run tests with pytest
        working-directory: ./services/${{ matrix.service }}
        run: |
          if [ -d tests ]; then
            pytest -q --cov=app --cov-report=term --cov-fail-under=20
          else
            echo "No tests directory found; skipping."
          fi

  python-dependency-audit:
    name: Python dependency audit (${{ matrix.service }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - agent-service
          - auth-service
          - banking-connector
          - compliance-service
          - consent-service
          - partner-registry
          - tax-engine
          - transactions-service
          - user-profile-service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install audit tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install pip-audit

      - name: Audit runtime dependencies for ${{ matrix.service }}
        run: |
          TARGET_DIR="$(mktemp -d)"
          python -m pip install -r services/${{ matrix.service }}/requirements.txt --target "$TARGET_DIR"
          # CVE-2024-23342 (ecdsa) currently has no published fixed version.
          python -m pip_audit --path "$TARGET_DIR" --ignore-vuln CVE-2024-23342

  smoke-core-flow:
    name: Smoke core flow checks
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r services/auth-service/requirements.txt
          pip install -r services/user-profile-service/requirements.txt
          pip install -r services/transactions-service/requirements.txt
          pip install -r services/consent-service/requirements.txt
          pip install -r services/partner-registry/requirements.txt
          pip install pytest-cov

      - name: Run smoke tests for core user flow
        run: |
          coverage erase
          pytest -q services/auth-service/tests/test_main.py::test_login_and_get_me \
            --cov=services/auth-service/app --cov-append --cov-report=
          pytest -q services/user-profile-service/tests/test_main.py::test_create_and_get_profile \
            --cov=services/user-profile-service/app --cov-append --cov-report=
          pytest -q services/transactions-service/tests/test_main.py::test_import_and_get_transactions \
            --cov=services/transactions-service/app --cov-append --cov-report=
          pytest -q services/consent-service/tests/test_main.py::test_record_consent_triggers_audit \
            --cov=services/consent-service/app --cov-append --cov-report=
          pytest -q services/partner-registry/tests/test_main.py::test_handoff_triggers_audit \
            --cov=services/partner-registry/app --cov-append --cov-report=
          pytest -q services/partner-registry/tests/test_main.py::test_generate_list_and_get_invoice \
            --cov=services/partner-registry/app --cov-append --cov-report=
          pytest -q services/partner-registry/tests/test_main.py::test_invoice_pdf_and_accounting_exports \
            --cov=services/partner-registry/app --cov-append --cov-report=
          coverage report --fail-under=25

  contract-tests:
    name: Contract tests
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
      ENABLE_CONTRACT_TESTS: "1"
      PACT_OUTPUT_DIR: ${{ runner.temp }}/pacts

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r services/tax-engine/requirements.txt
          pip install -r services/transactions-service/requirements.txt

      - name: Run consumer contract tests (tax-engine)
        run: |
          pytest -q services/tax-engine/tests/test_contract.py
          test -f "$PACT_OUTPUT_DIR/TaxEngineService-TransactionsService.json"

      - name: Run provider contract tests (transactions-service)
        run: |
          pytest -q services/transactions-service/tests/test_contract.py

  web-portal:
    name: Web portal checks
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./apps/web-portal

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: apps/web-portal/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Audit production dependencies
        run: npm audit --omit=dev

      - name: Type check
        run: npx next typegen && npx tsc --noEmit

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build
