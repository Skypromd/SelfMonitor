# Журнал обновлений: 2025-10-04

## Новая функциональность: Автоматическая категоризация транзакций (Этап 1 и 2)

Сегодня был сделан первый большой шаг в рамках **Фазы 2** нашего плана развития, направленной на внедрение элементов машинного обучения.

### 1. Создан сервис `categorization-service`
- **Что это:** Новый микросервис, который имитирует работу ML-модели для автоматического определения категории транзакции по её текстовому описанию.
- **Технология:** На данном этапе сервис использует простую, но эффективную систему правил (например, если в описании есть "TESCO", то категория — "groceries").
- **Цель:** Создать независимый компонент для всей логики, связанной с ML, который в будущем можно будет легко заменить на настоящую модель без изменения других частей системы.

### 2. Интеграция с `transactions-service`
- **Что это:** Модернизирован `transactions-service`. Теперь, при импорте новых транзакций, он не просто сохраняет их, а сначала отправляет описание каждой транзакции в `categorization-service`.
- **Как это работает:**
    1. `banking-connector` получает транзакции.
    2. Он отправляет их в `transactions-service` на импорт.
    3. `transactions-service` для каждой транзакции делает запрос к `categorization-service`.
    4. `categorization-service` возвращает предложенную категорию.
    5. `transactions-service` сохраняет транзакцию в базу данных **уже с присвоенной категорией**.

### 3. Обновление системной конфигурации
- **Что это:** Файл `docker-compose.yml` был обновлён для запуска нового сервиса и настройки сетевого взаимодействия между `transactions-service` и `categorization-service`.

**Итог:** Теперь наша система умеет не только собирать, но и автоматически обогащать данные, что значительно снижает объём ручной работы для конечного пользователя.

---
## Начало Фазы 3: Усиление Compliance

### 1. Модернизация `compliance-service`
- **Что это:** Мы начали переход к production-ready архитектуре, заменив хранение аудиторского журнала в оперативной памяти на постоянное хранение в базе данных PostgreSQL.
- **Технология:**
    - Сервис подключен к той же базе данных PostgreSQL, что и другие сервисы.
    - Настроена система миграций **Alembic** для управления схемой таблицы `audit_events`.
    - Логика сервиса теперь использует **SQLAlchemy** для асинхронной работы с базой данных.
- **Цель:** Обеспечить **надёжность и постоянство** аудиторского журнала. Все записи о важных действиях (выдача согласия, передача партнёру) теперь не теряются при перезапуске и хранятся в единой базе данных. На уровне API сервис по-прежнему является **append-only** (только добавление и чтение), что является шагом к созданию неизменяемого журнала.

---
## Начало Фазы 4: Усиление безопасности и подготовка к "Enterprise"

### 1. Безопасное управление секретами
- **Что это:** Устранена критическая уязвимость в `auth-service`, где секретный ключ для подписи JWT-токенов был жёстко закодирован в исходном коде.
- **Как это работает:**
    - Ключ `SECRET_KEY` теперь считывается из переменной окружения `AUTH_SECRET_KEY`.
    - В `docker-compose.yml` добавлено определение этой переменной. Это имитирует production-практику, где секреты поставляются в среду выполнения из защищённых хранилищ (например, AWS Secrets Manager, HashiCorp Vault), а не хранятся в коде.
- **Цель:** Повысить уровень безопасности приложения и сделать первый шаг к соответствию требованиям сертификаций SOC2/ISO27001.

### 2. Переход на облачное хранилище (AWS S3)
- **Что это:** Модернизирован `documents-service`. Вместо сохранения загруженных файлов в локальный Docker-том, сервис теперь загружает их в облачное объектное хранилище AWS S3.
- **Технология:**
    - Для локальной разработки был интегрирован **LocalStack**, который эмулирует S3 на машине разработчика.
    - В сервис добавлен AWS SDK (`boto3`) для взаимодействия с S3.
    - `docker-compose.yml` теперь автоматически создаёт S3 "ведро" (bucket) при старте системы.
- **Цель:** Обеспечить **надёжность, масштабируемость и безопасность** хранения файлов. В отличие от локального тома, S3 предоставляет практически бесконечное пространство, версионирование, шифрование и гибкие политики доступа, что является стандартом для продакшн-систем.

### 3. Внедрение распределённой очереди задач (Celery + Redis)
- **Что это:** Заменена встроенная в FastAPI система фоновых задач (`BackgroundTasks`) на полноценную, распределённую очередь задач Celery с брокером сообщений Redis.
- **Как это работает:**
    - В `docker-compose.yml` добавлены два новых сервиса: `redis` и `celery-worker`.
    - `banking-connector` при "подключении" банка больше не выполняет импорт транзакций сам. Вместо этого он создаёт задачу и отправляет её в очередь Redis.
    - Отдельный, независимый процесс `celery-worker` забирает эту задачу из очереди и выполняет её, вызывая `transactions-service`.
- **Цель:** Повысить **надёжность и масштабируемость** фоновых операций. Теперь, если веб-сервис `banking-connector` упадёт или перезапустится, задача на импорт транзакций не потеряется. Также это позволяет в будущем масштабировать количество воркеров для обработки большого потока задач, не затрагивая веб-сервер.