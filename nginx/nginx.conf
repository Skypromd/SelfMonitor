worker_processes 1;

events {
    worker_connections 1024;
}

http {
    limit_req_zone $binary_remote_addr zone=api_global_per_ip:10m rate=30r/s;
    limit_req_zone $binary_remote_addr zone=auth_per_ip:10m rate=5r/s;
    limit_conn_zone $binary_remote_addr zone=per_ip_conn:10m;

    map $http_user_agent $waf_block_bad_ua {
        default 0;
        "~*(sqlmap|nikto|acunetix|nmap|masscan|wpscan)" 1;
    }

    map $request_uri $waf_block_bad_uri {
        default 0;
        "~*(\\.\\./|%2e%2e%2f|<script|%3cscript|union(?:\\+|%20)select|/\\.git|/\\.env|/wp-admin|/phpmyadmin)" 1;
    }

    map "$waf_block_bad_ua:$waf_block_bad_uri" $waf_block_reason {
        default "none";
        "1:0" "bad_user_agent_signature";
        "0:1" "bad_uri_signature";
        "1:1" "bad_user_agent_and_uri_signature";
    }

    log_format waf_json escape=json
        '{'
            '"timestamp":"$time_iso8601",'
            '"remote_addr":"$remote_addr",'
            '"method":"$request_method",'
            '"request_uri":"$request_uri",'
            '"status":$status,'
            '"body_bytes_sent":$body_bytes_sent,'
            '"request_time":$request_time,'
            '"upstream_response_time":"$upstream_response_time",'
            '"upstream_addr":"$upstream_addr",'
            '"http_referer":"$http_referer",'
            '"http_user_agent":"$http_user_agent",'
            '"waf_bad_ua":$waf_block_bad_ua,'
            '"waf_bad_uri":$waf_block_bad_uri,'
            '"waf_block_reason":"$waf_block_reason"'
        '}';

    # Define the upstream servers for each service
    upstream auth_service { server auth-service:80; }
    upstream user_profile_service { server user-profile-service:80; }
    upstream transactions_service { server transactions-service:80; }
    upstream compliance_service { server compliance-service:80; }
    upstream consent_service { server consent-service:80; }
    upstream banking_connector { server banking-connector:80; }
    upstream documents_service { server documents-service:80; }
    upstream tax_engine { server tax-engine:80; }
    upstream advice_service { server advice-service:80; }
    upstream partner_registry { server partner-registry:80; }
    upstream analytics_service { server analytics-service:80; }
    upstream localization_service { server localization-service:80; }
    upstream qna_service { server qna-service:80; }
    upstream referral_service { server referral-service:80; }
    upstream customer_success { server customer-success:80; }
    upstream pricing_engine { server pricing-engine:80; }
    upstream predictive_analytics { server predictive-analytics:80; }
    upstream cost_optimization { server cost-optimization:80; }
    upstream fraud_detection { server fraud-detection:80; }
    upstream business_intelligence { server business-intelligence:80; }
    upstream calendar_service { server calendar-service:80; }
    upstream agent_service { server agent-service:80; }

    # Main server block for handling all traffic on port 80
    server {
        listen 80;
        server_tokens off;
        client_max_body_size 12m;
        access_log /dev/stdout waf_json;
        error_log /dev/stderr warn;

        limit_conn per_ip_conn 30;
        limit_req zone=api_global_per_ip burst=120 nodelay;
        limit_req_status 429;

        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # Security headers
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;

        # CORS headers â€” restrict to known frontend origins
        set $cors_origin "";
        if ($http_origin ~* "^https?://localhost(:[0-9]+)?$") {
            set $cors_origin $http_origin;
        }

        # Health check
        location /health {
            return 200 'API Gateway is running';
        }

        if ($waf_block_bad_ua) {
            return 403;
        }

        if ($waf_block_bad_uri) {
            return 403;
        }

        if ($request_method !~ ^(GET|POST|PUT|PATCH|DELETE|OPTIONS|HEAD)$) {
            return 405;
        }

        location = /api/auth/token {
            limit_req zone=auth_per_ip burst=12 nodelay;
            rewrite /api/auth/(.*) /$1 break;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://auth_service;
        }

        location = /api/auth/register {
            limit_req zone=auth_per_ip burst=8 nodelay;
            rewrite /api/auth/(.*) /$1 break;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://auth_service;
        }

        # Rule for auth-service
        location /api/auth/ {
            limit_req zone=auth_limit burst=10 nodelay;

            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' $cors_origin always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                return 204;
            }

            add_header 'Access-Control-Allow-Origin' $cors_origin always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type' always;

            rewrite /api/auth/(.*) /$1 break;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://auth_service;
        }

        # Rule for user-profile-service
        location /api/profile/ {
            limit_req zone=api_limit burst=20 nodelay;

            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' $cors_origin always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                return 204;
            }

            add_header 'Access-Control-Allow-Origin' $cors_origin always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type' always;

            rewrite /api/profile/(.*) /$1 break;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://user_profile_service;
        }

        # Add rules for all other services...
        location /api/transactions/ { rewrite /api/transactions/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://transactions_service; }
        location /api/compliance/ { rewrite /api/compliance/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://compliance_service; }
        location /api/consent/ { rewrite /api/consent/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://consent_service; }
        location /api/banking/ { rewrite /api/banking/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://banking_connector; }
        location /api/documents/ { rewrite /api/documents/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://documents_service; }
        location /api/tax/ { rewrite /api/tax/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://tax_engine; }
        location /api/advice/ { rewrite /api/advice/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://advice_service; }
        location /api/partners/ { rewrite /api/partners/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://partner_registry; }
        location /api/integrations/ { rewrite /api/integrations/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://integrations_service; }
        location /api/analytics/ { rewrite /api/analytics/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://analytics_service; }
        location /api/localization/ { rewrite /api/localization/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://localization_service; }
        location /api/categorization/ { rewrite /api/categorization/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://categorization_service; }
        location /api/qna/ { rewrite /api/qna/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://qna_service; }
        location /api/calendar/ { rewrite /api/calendar/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://calendar_service; }
        location /api/agent/ { rewrite /api/agent/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://agent_service; }
    }
}
