worker_processes 1;

events {
    worker_connections 1024;
}

http {
    # Define the upstream servers for each service
    upstream auth_service { server auth-service:80; }
    upstream user_profile_service { server user-profile-service:80; }
    upstream transactions_service { server transactions-service:80; }
    upstream compliance_service { server compliance-service:80; }
    upstream consent_service { server consent-service:80; }
    upstream banking_connector { server banking-connector:80; }
    upstream documents_service { server documents-service:80; }
    upstream tax_engine { server tax-engine:80; }
    upstream advice_service { server advice-service:80; }
    upstream partner_registry { server partner-registry:80; }
    upstream analytics_service { server analytics-service:80; }
    upstream localization_service { server localization-service:80; }
    upstream qna_service { server qna-service:80; }

    # Main server block for handling all traffic on port 80
    server {
        listen 80;

        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
        }

        # Health check
        location /health {
            add_header 'Access-Control-Allow-Origin' '*' always;
            return 200 'API Gateway is running';
        }

        # Rule for auth-service
        location /api/auth/ {
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;
            
            rewrite /api/auth/(.*) /$1 break;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://auth_service;
        }

        # Rule for user-profile-service
        location /api/profile/ {
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;
            
            rewrite /api/profile/(.*) /$1 break;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://user_profile_service;
        }

        # Add rules for all other services...
        location /api/transactions/ { add_header 'Access-Control-Allow-Origin' '*' always; rewrite /api/transactions/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://transactions_service; }
        location /api/compliance/ { add_header 'Access-Control-Allow-Origin' '*' always; rewrite /api/compliance/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://compliance_service; }
        location /api/consent/ { add_header 'Access-Control-Allow-Origin' '*' always; rewrite /api/consent/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://consent_service; }
        location /api/banking/ { add_header 'Access-Control-Allow-Origin' '*' always; rewrite /api/banking/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://banking_connector; }
        location /api/documents/ { add_header 'Access-Control-Allow-Origin' '*' always; rewrite /api/documents/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://documents_service; }
        location /api/tax/ { add_header 'Access-Control-Allow-Origin' '*' always; rewrite /api/tax/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://tax_engine; }
        location /api/advice/ { add_header 'Access-Control-Allow-Origin' '*' always; rewrite /api/advice/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://advice_service; }
        location /api/partners/ { add_header 'Access-Control-Allow-Origin' '*' always; rewrite /api/partners/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://partner_registry; }
        location /api/analytics/ { add_header 'Access-Control-Allow-Origin' '*' always; rewrite /api/analytics/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://analytics_service; }
        location /api/localization/ { add_header 'Access-Control-Allow-Origin' '*' always; rewrite /api/localization/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://localization_service; }
        location /api/qna/ { add_header 'Access-Control-Allow-Origin' '*' always; rewrite /api/qna/(.*) /$1 break; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://qna_service; }
    }
}
