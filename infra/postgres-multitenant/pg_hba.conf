# PostgreSQL Client Authentication Configuration File
# Multi-Tenant SelfMonitor FinTech Platform Configuration

# TYPE  DATABASE        USER            ADDRESS                 METHOD

# "local" is for Unix domain socket connections only
local   all             all                                     trust

# IPv4 local connections:
host    all             all             127.0.0.1/32            scram-sha-256

# IPv6 local connections:
host    all             all             ::1/128                 scram-sha-256

# Allow replication connections from localhost, by a user with the
# replication privilege.
local   replication     all                                     trust
host    replication     all             127.0.0.1/32            scram-sha-256
host    replication     all             ::1/128                 scram-sha-256

#------------------------------------------------------------------------------
# MULTI-TENANT SPECIFIC AUTHENTICATION
#------------------------------------------------------------------------------

# Docker network connections (adjust subnet as needed)
host    all             all             172.30.0.0/16           scram-sha-256

# Tenant Router Service connections
host    all             tenant_user     172.30.0.0/16           scram-sha-256

# Application service connections  
host    all             postgres        172.30.0.0/16           scram-sha-256
host    all             tenant_user     172.30.0.0/16           scram-sha-256

# Individual tenant database connections
# These are dynamically created databases, so we allow tenant_user access to all
host    tenant_*        tenant_user     172.30.0.0/16           scram-sha-256

#------------------------------------------------------------------------------
# DEVELOPMENT AND TESTING
#------------------------------------------------------------------------------

# Allow connections from local development environment
host    all             all             192.168.0.0/16          scram-sha-256
host    all             all             10.0.0.0/8              scram-sha-256

#------------------------------------------------------------------------------
# MONITORING AND ADMINISTRATION
#------------------------------------------------------------------------------

# pgAdmin and monitoring tools
host    all             postgres        172.30.0.0/16           scram-sha-256

# Prometheus postgres exporter connections
host    all             postgres        172.30.0.0/16           scram-sha-256

#------------------------------------------------------------------------------
# BACKUP AND MAINTENANCE
#------------------------------------------------------------------------------

# Backup service connections
host    all             tenant_user     172.30.0.0/16           scram-sha-256

#------------------------------------------------------------------------------
# SECURITY NOTES
#------------------------------------------------------------------------------

# 1. scram-sha-256 is used for enhanced password security
# 2. Connections are restricted to Docker network subnet
# 3. Individual tenant databases use consistent naming pattern (tenant_*)
# 4. Replication user has limited scope for security
# 5. Local connections use trust for container initialization

#------------------------------------------------------------------------------
# PRODUCTION CONSIDERATIONS
#------------------------------------------------------------------------------

# For production deployment:
# 1. Use specific IP ranges instead of broad subnets
# 2. Consider certificate-based authentication for high security
# 3. Implement connection auditing
# 4. Use SSL/TLS encryption for all connections
# 5. Restrict superuser access to specific IPs

# Example production entries:
# hostssl tenant_*      tenant_user     10.1.2.0/24             cert
# hostssl all          backup_user     10.1.3.100/32           scram-sha-256

#------------------------------------------------------------------------------
# TENANT ISOLATION ENFORCEMENT
#------------------------------------------------------------------------------

# The application enforces tenant isolation through:
# 1. Row Level Security policies in each database
# 2. Connection pooling with tenant context
# 3. Application-level tenant routing
# 4. Database-level separation (separate DB per tenant)

# No additional HBA rules needed for tenant isolation as it's enforced
# at the database and application level