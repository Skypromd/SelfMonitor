# PostgreSQL Configuration for Multi-Tenant Architecture
# Optimized for SelfMonitor FinTech Platform - Shard Configuration

#------------------------------------------------------------------------------
# FILE LOCATIONS
#------------------------------------------------------------------------------

# The default values of these variables are driven from the -D command-line
# option or PGDATA environment variable, represented here as ConfigDir.

data_directory = '/var/lib/postgresql/data'
hba_file = '/etc/postgresql/pg_hba.conf'
ident_file = '/var/lib/postgresql/data/pg_ident.conf'

# If external_pid_file is not explicitly set, no extra PID file is written.
external_pid_file = '/var/run/postgresql/postgresql.pid'

#------------------------------------------------------------------------------
# CONNECTIONS AND AUTHENTICATION
#------------------------------------------------------------------------------

# Connection settings optimized for multi-tenant workloads
listen_addresses = '*'
port = 5432
max_connections = 200                    # Increased for multiple tenants
superuser_reserved_connections = 3

# Authentication
authentication_timeout = 60s
password_encryption = scram-sha-256      # Enhanced security

#------------------------------------------------------------------------------
# RESOURCE USAGE (except WAL)
#------------------------------------------------------------------------------

# Memory settings optimized for tenant database workloads
shared_buffers = 256MB                   # Adjust based on available RAM
huge_pages = try
temp_buffers = 8MB

# Work memory settings for concurrent tenant queries
work_mem = 16MB                          # Per-operation memory
maintenance_work_mem = 128MB
max_stack_depth = 2MB

# Vacuum and autovacuum settings
autovacuum_work_mem = 128MB
dynamic_shared_memory_type = posix

#------------------------------------------------------------------------------
# WRITE-AHEAD LOGGING
#------------------------------------------------------------------------------

# WAL settings optimized for high-throughput multi-tenant operations
wal_level = replica
fsync = on
synchronous_commit = on
wal_sync_method = fsync
full_page_writes = on
wal_compression = on                     # Compress WAL for efficiency
wal_log_hints = on

# WAL buffering
wal_buffers = 16MB
wal_writer_delay = 200ms
commit_delay = 0
commit_siblings = 5

# Checkpoints
checkpoint_timeout = 5min
checkpoint_completion_target = 0.9
max_wal_size = 2GB
min_wal_size = 256MB

#------------------------------------------------------------------------------
# REPLICATION
#------------------------------------------------------------------------------

# Replication settings for tenant data safety
max_wal_senders = 10
max_replication_slots = 10
hot_standby = on
hot_standby_feedback = off
wal_receiver_status_interval = 10s
hot_standby_feedback = off

#------------------------------------------------------------------------------
# QUERY TUNING
#------------------------------------------------------------------------------

# Cost-based optimizer settings
random_page_cost = 1.1                  # SSD storage
effective_cache_size = 1GB              # Estimate of OS cache
seq_page_cost = 1.0
cpu_tuple_cost = 0.01
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025

# Query planning
default_statistics_target = 500         # Higher stats for better plans
constraint_exclusion = partition
from_collapse_limit = 8
join_collapse_limit = 8

# Parallel query settings
max_parallel_workers_per_gather = 4
max_parallel_workers = 8
max_parallel_maintenance_workers = 4
parallel_tuple_cost = 0.1
parallel_setup_cost = 1000.0

#------------------------------------------------------------------------------
# REPORTING AND LOGGING
#------------------------------------------------------------------------------

# Logging configuration for multi-tenant monitoring
log_destination = 'stderr'
logging_collector = on
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_file_mode = 0600
log_rotation_age = 1d                   # Daily rotation
log_rotation_size = 100MB
log_truncate_on_rotation = off

# What to log
log_min_messages = warning
log_min_error_statement = error
log_min_duration_statement = 1000       # Log slow queries (1 second)
log_connections = on                     # Track tenant connections
log_disconnections = on
log_duration = off
log_line_prefix = '%m [%p] %q%u@%d '    # Timestamp, PID, user, database
log_lock_waits = on                      # Monitor tenant contention
log_statement = 'none'
log_temp_files = 10MB                   # Log large temp files

# Process title
cluster_name = 'selfmonitor-multitenant'
update_process_title = on

#------------------------------------------------------------------------------
# STATISTICS
#------------------------------------------------------------------------------

# Statistics collection for performance monitoring
track_activities = on
track_functions = all
track_io_timing = on                     # Track I/O for tenant analysis
track_wal_io_timing = on
stats_temp_directory = '/var/run/postgresql'

# Statement statistics (requires pg_stat_statements extension)
shared_preload_libraries = 'pg_stat_statements'

#------------------------------------------------------------------------------
# AUTOVACUUM
#------------------------------------------------------------------------------

# Autovacuum tuned for multi-tenant workloads
autovacuum = on
autovacuum_naptime = 30s                 # More frequent checks
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.1     # Vacuum sooner
autovacuum_analyze_scale_factor = 0.05   # Analyze sooner
autovacuum_freeze_max_age = 200000000
autovacuum_multixact_freeze_max_age = 400000000
autovacuum_vacuum_cost_delay = 10ms
autovacuum_vacuum_cost_limit = 1000

#------------------------------------------------------------------------------
# LOCK MANAGEMENT
#------------------------------------------------------------------------------

# Lock settings for concurrent tenant operations
deadlock_timeout = 1s
max_locks_per_transaction = 256          # Higher for complex tenant queries
max_pred_locks_per_transaction = 256
max_pred_locks_per_relation = 256
max_pred_locks_per_page = 8

#------------------------------------------------------------------------------
# VERSION AND PLATFORM COMPATIBILITY
#------------------------------------------------------------------------------

# Array and text search
array_nulls = on
backslash_quote = safe_encoding
default_with_oids = off
escape_string_warning = on
lo_compat_privileges = off
operator_precedence_warning = off
quote_all_identifiers = off
standard_conforming_strings = on
synchronize_seqscans = on

#------------------------------------------------------------------------------
# ERROR HANDLING
#------------------------------------------------------------------------------

exit_on_error = off
restart_after_crash = on

#------------------------------------------------------------------------------
# CONFIG FILE INCLUDES
#------------------------------------------------------------------------------

# Include additional configuration files for tenant-specific settings
# include_dir = 'conf.d'
# include_if_exists = 'exists.conf'
# include = 'special.conf'

#------------------------------------------------------------------------------
# MULTI-TENANT SPECIFIC SETTINGS
#------------------------------------------------------------------------------

# Connection pooling and tenant isolation
tcp_keepalives_idle = 600
tcp_keepalives_interval = 30
tcp_keepalives_count = 3

# Row Level Security enforcement
row_security = on

# JSON optimization for tenant metadata
max_parallel_workers_per_gather = 4

# Maintenance automation
log_autovacuum_min_duration = 0         # Log all autovacuum operations

# Custom variables for tenant context
# custom_variable_classes = 'app'        # Deprecated in newer versions

#------------------------------------------------------------------------------
# EXTENSIONS CONFIGURATION
#------------------------------------------------------------------------------

# Pre-load extensions commonly used by tenant applications
# shared_preload_libraries = 'pg_stat_statements,auto_explain'

# Statement timeout for tenant queries
statement_timeout = 300s                # 5 minutes max per query
lock_timeout = 30s                      # 30 seconds max lock wait
idle_in_transaction_session_timeout = 600s  # 10 minutes idle timeout

#------------------------------------------------------------------------------
# TENANT-SPECIFIC CONNECTION LIMITS
#------------------------------------------------------------------------------

# These can be set per database for tenant-specific limits
# ALTER DATABASE tenant_123 SET statement_timeout = '60s';
# ALTER DATABASE tenant_123 SET lock_timeout = '10s';

#------------------------------------------------------------------------------
# PERFORMANCE MONITORING
#------------------------------------------------------------------------------

# Additional monitoring for multi-tenant performance
log_checkpoints = on
log_autovacuum_min_duration = 0
log_temp_files = 0

# Track tenant-specific statistics
compute_query_id = on