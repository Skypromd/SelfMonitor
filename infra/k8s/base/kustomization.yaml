apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# SelfMonitor Platform - Base Kubernetes Configuration
# This file defines the base Kubernetes resources for all environments

metadata:
  name: selfmonitor-base
  annotations:
    version: "2.0.0"
    description: "Enterprise FinTech Platform - Kubernetes Base Configuration"

# Define namespace for all resources
namespace: selfmonitor

# Common labels applied to all resources
commonLabels:
  app.kubernetes.io/name: selfmonitor
  app.kubernetes.io/version: "2.0.0"
  app.kubernetes.io/managed-by: kustomize
  project: selfmonitor-fintech
  tier: platform

# Resource definitions
resources:
  # Networking and Service Discovery
  - networking/namespace.yaml
  - networking/network-policy.yaml
  
  # Storage and Database
  - storage/postgres-pv.yaml
  - storage/postgres-pvc.yaml
  - storage/redis-pvc.yaml
  - database/postgres-configmap.yaml
  - database/postgres-deployment.yaml
  - database/postgres-service.yaml
  - database/redis-deployment.yaml
  - database/redis-service.yaml
  
  # Core Services (19 microservices + AI agent)
  - services/auth-service.yaml
  - services/user-profile-service.yaml
  - services/transactions-service.yaml
  - services/analytics-service.yaml
  - services/banking-connector.yaml
  - services/calendar-service.yaml
  - services/categorization-service.yaml
  - services/compliance-service.yaml
  - services/consent-service.yaml
  - services/documents-service.yaml
  - services/integrations-service.yaml
  - services/localization-service.yaml
  - services/partner-registry.yaml
  - services/qna-service.yaml
  - services/tax-engine.yaml
  - services/advice-service.yaml
  - services/ai-agent-service.yaml
  - services/business-intelligence.yaml
  - services/fraud-detection.yaml
  - services/predictive-analytics.yaml
  
  # Gateway and Load Balancing
  - gateway/nginx-configmap.yaml
  - gateway/nginx-deployment.yaml
  - gateway/nginx-service.yaml
  - gateway/ingress.yaml
  
  # Monitoring and Observability
  - monitoring/prometheus-deployment.yaml
  - monitoring/grafana-deployment.yaml
  - monitoring/service-monitor.yaml
  
  # Service Mesh and Advanced Networking
  - service-mesh/istio-operator.yaml
  - service-mesh/security-policies.yaml 
  - service-mesh/traffic-management.yaml
  
  # Distributed Tracing
  - observability/jaeger.yaml

# Secret generators for sensitive data
secretGenerator:
  - name: postgres-secret
    literals:
      - POSTGRES_USER=selfmonitor
      - POSTGRES_PASSWORD=CHANGE_ME_IN_OVERLAY
      - POSTGRES_DB=selfmonitor
  
  - name: auth-secret
    literals:
      - AUTH_SECRET_KEY=CHANGE_ME_IN_OVERLAY
      - JWT_SECRET_KEY=CHANGE_ME_IN_OVERLAY
  
  - name: openai-secret
    literals:
      - OPENAI_API_KEY=CHANGE_ME_IN_OVERLAY
  
  - name: banking-secret
    literals:
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=CHANGE_ME_IN_OVERLAY
      - BANKING_API_KEY=CHANGE_ME_IN_OVERLAY
  
  - name: storage-secret
    literals:
      - AWS_ACCESS_KEY_ID=CHANGE_ME_IN_OVERLAY
      - AWS_SECRET_ACCESS_KEY=CHANGE_ME_IN_OVERLAY
      - S3_BUCKET_NAME=selfmonitor-docs

# ConfigMap generator for application configuration
configMapGenerator:
  - name: app-config
    literals:
      - ENVIRONMENT=production
      - LOG_LEVEL=INFO
      - REDIS_HOST=redis-service
      - REDIS_PORT="6379"
      - POSTGRES_HOST=postgres-service
      - POSTGRES_PORT="5432"
      - NGINX_PORT="80"
      - METRICS_PORT="9090"
      - HEALTH_CHECK_INTERVAL=30s
      - SESSION_TIMEOUT=3600
      - MAX_CONNECTIONS=100
      - CORS_ORIGINS=https://selfmonitor.app,https://app.selfmonitor.app

# Image transformations
images:
  - name: postgres
    newTag: "15-alpine"
  - name: redis
    newTag: "7-alpine"
  - name: nginx
    newTag: "1.25-alpine"
  - name: selfmonitor/auth-service
    newTag: "latest"
  - name: selfmonitor/ai-agent-service
    newTag: "latest"

# Patches for common configurations
patches:
  # Add security context to all deployments
  - target:
      kind: Deployment
    patch: |-
      - op: add
        path: /spec/template/spec/securityContext
        value:
          runAsNonRoot: true
          runAsUser: 1001
          fsGroup: 1001
  
  # Add resource limits to all containers
  - target:
      kind: Deployment
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"

# Replicas for high availability
replicas:
  - name: nginx-deployment
    count: 3
  - name: auth-service-deployment
    count: 3
  - name: ai-agent-service-deployment
    count: 2
  - name: user-profile-service-deployment
    count: 2
  - name: transactions-service-deployment
    count: 3
  - name: analytics-service-deployment
    count: 2