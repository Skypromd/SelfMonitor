apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# SelfMonitor Platform - Production Environment Configuration
# This overlay customizes the base configuration for production deployment

metadata:
  name: selfmonitor-production
  annotations:
    version: "2.0.0"
    environment: "production"
    description: "Production deployment configuration for SelfMonitor FinTech Platform"

# Base configuration
resources:
- ../../base

# Namespace for production
namespace: selfmonitor

# Production labels
commonLabels:
  environment: production
  deployment-tier: production

# Production-specific resource patches
patches:
# Increase replicas for high availability
- target:
    kind: Deployment
    name: nginx-deployment
  patch: |-
    - op: replace
      path: /spec/replicas
      value: 5

- target:
    kind: Deployment
    name: auth-service-deployment
  patch: |-
    - op: replace
      path: /spec/replicas
      value: 5

- target:
    kind: Deployment
    name: ai-agent-service-deployment
  patch: |-
    - op: replace
      path: /spec/replicas
      value: 3

- target:
    kind: Deployment
    name: user-profile-service-deployment
  patch: |-
    - op: replace
      path: /spec/replicas
      value: 3

# Increase resource limits for production workloads
- target:
    kind: Deployment
    name: postgres-deployment
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          memory: "4Gi"
          cpu: "2000m"
        limits:
          memory: "8Gi"
          cpu: "4000m"

- target:
    kind: Deployment
    name: redis-deployment
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          memory: "2Gi"
          cpu: "500m"
        limits:
          memory: "4Gi"
          cpu: "1000m"

- target:
    kind: Deployment
    name: ai-agent-service-deployment
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          memory: "2Gi"
          cpu: "1000m"
        limits:
          memory: "8Gi"
          cpu: "4000m"

# Production storage configurations
- target:
    kind: PersistentVolumeClaim
    name: postgres-pvc
  patch: |-
    - op: replace
      path: /spec/resources/requests/storage
      value: 200Gi

- target:
    kind: PersistentVolumeClaim
    name: postgres-backup-pvc
  patch: |-
    - op: replace
      path: /spec/resources/requests/storage
      value: 500Gi

- target:
    kind: PersistentVolumeClaim
    name: redis-pvc
  patch: |-
    - op: replace
      path: /spec/resources/requests/storage
      value: 50Gi

# Production secrets (placeholder - replace with real values)
secretGenerator:
- name: postgres-secret
  behavior: replace
  literals:
  - POSTGRES_USER=selfmonitor_prod
  - POSTGRES_PASSWORD=REPLACE_WITH_SECURE_PASSWORD_FROM_VAULT
  - POSTGRES_DB=selfmonitor_production

- name: auth-secret
  behavior: replace
  literals:
  - AUTH_SECRET_KEY=REPLACE_WITH_SECURE_KEY_FROM_VAULT
  - JWT_SECRET_KEY=REPLACE_WITH_JWT_SECRET_FROM_VAULT

- name: openai-secret
  behavior: replace
  literals:
  - OPENAI_API_KEY=REPLACE_WITH_OPENAI_API_KEY_FROM_VAULT

- name: banking-secret
  behavior: replace
  literals:
  - VAULT_ADDR=https://vault.selfmonitor.app:8200
  - VAULT_TOKEN=REPLACE_WITH_VAULT_TOKEN
  - BANKING_API_KEY=REPLACE_WITH_BANKING_API_KEY

- name: redis-secret
  behavior: replace
  literals:
  - REDIS_PASSWORD=REPLACE_WITH_REDIS_PASSWORD

- name: weaviate-secret
  behavior: replace
  literals:
  - WEAVIATE_API_KEY=REPLACE_WITH_WEAVIATE_KEY

- name: service-secret
  behavior: replace
  literals:
  - API_KEY=REPLACE_WITH_SERVICE_API_KEY

- name: grafana-secret
  behavior: replace
  literals:
  - admin-password=REPLACE_WITH_GRAFANA_PASSWORD

- name: postgres-monitoring-secret
  behavior: replace
  literals:
  - DATA_SOURCE_NAME=postgresql://monitoring:REPLACE_WITH_MONITORING_PASSWORD@postgres-service:5432/db_monitoring?sslmode=disable

- name: monitoring-auth
  type: Opaque
  literals:
  - auth=admin:$2y$10$REPLACE_WITH_BCRYPT_HASH  # admin:monitoring_password

# Production ConfigMaps
configMapGenerator:
- name: app-config
  behavior: replace
  literals:
  - ENVIRONMENT=production
  - LOG_LEVEL=WARNING
  - REDIS_HOST=redis-service
  - REDIS_PORT="6379"
  - POSTGRES_HOST=postgres-service
  - POSTGRES_PORT="5432"
  - NGINX_PORT="80"
  - METRICS_PORT="9090"
  - HEALTH_CHECK_INTERVAL=30s
  - SESSION_TIMEOUT=7200
  - MAX_CONNECTIONS=1000
  - CORS_ORIGINS=https://selfmonitor.app,https://app.selfmonitor.app,https://ai.selfmonitor.app
  - SSL_VERIFY=true
  - RATE_LIMITING=true
  - SECURITY_HEADERS=true

# Image tags for production
images:
- name: selfmonitor/auth-service
  newTag: "v2.0.0"
- name: selfmonitor/user-profile-service
  newTag: "v2.0.0"
- name: selfmonitor/transactions-service
  newTag: "v2.0.0"
- name: selfmonitor/ai-agent-service
  newTag: "v1.0.0"
- name: selfmonitor/analytics-service
  newTag: "v2.0.0"
- name: selfmonitor/advice-service
  newTag: "v2.0.0"
- name: postgres
  newTag: "15.5-alpine"
- name: redis
  newTag: "7.2-alpine"
- name: nginx
  newTag: "1.25.3-alpine"

# Production-specific replicas
replicas:
- name: nginx-deployment
  count: 5
- name: auth-service-deployment
  count: 5
- name: ai-agent-service-deployment
  count: 3
- name: user-profile-service-deployment
  count: 3
- name: transactions-service-deployment
  count: 3
- name: analytics-service-deployment
  count: 3
- name: postgres-deployment
  count: 1  # Single master with read replicas
- name: redis-deployment
  count: 1  # Single instance with persistence