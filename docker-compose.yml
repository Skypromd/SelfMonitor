version: '3.8'

services:
  nginx-gateway:
    build: ./nginx
    container_name: nginx-gateway
    ports:
      - "8000:80" # The single entry point for our backend
    depends_on:
      - auth-service
      - user-profile-service
      - transactions-service
      - compliance-service
      - consent-service
      - banking-connector
      - documents-service
      - tax-engine
      - advice-service
      - partner-registry
      - integrations-service
      - analytics-service
      - localization-service
      - categorization-service
      - qna-service
      - calendar-service
    networks:
      - default_network

  postgres:
    image: postgres:15-alpine
    container_name: postgres_db
    volumes:
      - postgres_data:/var/lib/postgresql/data/
      - ./infra/postgres:/docker-entrypoint-initdb.d # Run init scripts
    environment:
      POSTGRES_USER: "${POSTGRES_USER:-user}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-password}"
      POSTGRES_DB: "${POSTGRES_DB:-db_user_profile}"
    ports:
      - "5432:5432" # Expose port for local inspection
    networks:
      - default_network

  auth-service:
    build: ./services/auth-service
    container_name: auth-service
    environment:
      # This is how we pass secrets to our services in a production-like environment.
      # In a real cloud deployment, this would come from a secret manager (like AWS Secrets Manager or HashiCorp Vault).
      AUTH_SECRET_KEY: "${AUTH_SECRET_KEY:-a_secure_random_string_for_jwt_signing_!@#$%^}"
    # ports are no longer exposed directly
    networks:
      - default_network

  user-profile-service:
    build: ./services/user-profile-service
    container_name: user-profile-service
    depends_on:
      - postgres
    environment:
      AUTH_SECRET_KEY: "${AUTH_SECRET_KEY:-a_secure_random_string_for_jwt_signing_!@#$%^}"
      DATABASE_URL: "${USER_PROFILE_DATABASE_URL:-postgresql+asyncpg://user:password@postgres/db_user_profile}"
    # Run migrations before starting the app server
    command: sh -c "alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port 80"
    networks:
      - default_network

  transactions-service:
    build: ./services/transactions-service
    container_name: transactions-service
    depends_on:
      - postgres
      - categorization-service
    environment:
      AUTH_SECRET_KEY: "${AUTH_SECRET_KEY:-a_secure_random_string_for_jwt_signing_!@#$%^}"
      DATABASE_URL: "${TRANSACTIONS_DATABASE_URL:-postgresql+asyncpg://user:password@postgres/db_transactions}"
      CATEGORIZATION_SERVICE_URL: "${CATEGORIZATION_SERVICE_URL:-http://categorization-service/categorize}"
    command: sh -c "alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port 80"
    networks:
      - default_network

  compliance-service:
    build: ./services/compliance-service
    container_name: compliance-service
    depends_on:
      - postgres
    environment:
      DATABASE_URL: "${COMPLIANCE_DATABASE_URL:-postgresql+asyncpg://user:password@postgres/db_compliance}"
    command: sh -c "alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port 80"
    networks:
      - default_network

  consent-service:
    build: ./services/consent-service
    container_name: consent-service
    depends_on:
      - compliance-service
      - postgres
    environment:
      AUTH_SECRET_KEY: "${AUTH_SECRET_KEY:-a_secure_random_string_for_jwt_signing_!@#$%^}"
      DATABASE_URL: "${CONSENT_DATABASE_URL:-postgresql+asyncpg://user:password@postgres/db_consent}"
      COMPLIANCE_SERVICE_URL: "${CONSENT_COMPLIANCE_SERVICE_URL:-http://compliance-service/audit-events}"
    networks:
      - default_network

  banking-connector:
    build: ./services/banking-connector
    container_name: banking-connector
    depends_on:
      - transactions-service
      - vault
    environment:
      AUTH_SECRET_KEY: "${AUTH_SECRET_KEY:-a_secure_random_string_for_jwt_signing_!@#$%^}"
      TRANSACTIONS_SERVICE_URL: "${BANKING_TRANSACTIONS_SERVICE_URL:-http://transactions-service/import}"
      VAULT_ADDR: "${BANKING_VAULT_ADDR:-http://vault:8200}"
      VAULT_TOKEN: "${BANKING_VAULT_TOKEN:-dev-root-token}" # This is the default root token for Vault's dev mode
    networks:
      - default_network

  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - default_network

  celery-worker:
    build: ./services/banking-connector # Use the same image as the web server
    container_name: celery-worker
    command: celery -A app.celery_app.celery worker --loglevel=info
    depends_on:
      - redis
      - transactions-service
    environment:
      # Pass the same environment variables as the web server
      TRANSACTIONS_SERVICE_URL: "${BANKING_TRANSACTIONS_SERVICE_URL:-http://transactions-service/import}"
      CELERY_BROKER_URL: "${CELERY_BROKER_URL:-redis://redis:6379/0}"
      CELERY_RESULT_BACKEND: "${CELERY_RESULT_BACKEND:-redis://redis:6379/0}"
    networks:
      - default_network

  celery-worker-docs:
    build: ./services/documents-service
    container_name: celery-worker-docs
    command: celery -A app.celery_app.celery worker --loglevel=info
    depends_on:
      - redis
      - postgres
      - localstack
      - qna-service
    environment:
      DATABASE_URL: "${DOCUMENTS_DATABASE_URL:-postgresql+asyncpg://user:password@postgres/db_documents}"
      CELERY_BROKER_URL: "${CELERY_BROKER_URL:-redis://redis:6379/0}"
      CELERY_RESULT_BACKEND: "${CELERY_RESULT_BACKEND:-redis://redis:6379/0}"
      AUTH_SECRET_KEY: "${AUTH_SECRET_KEY:-a_secure_random_string_for_jwt_signing_!@#$%^}"
      AWS_ENDPOINT_URL: "${DOCUMENTS_AWS_ENDPOINT_URL:-http://localstack:4566}"
      AWS_ACCESS_KEY_ID: "${DOCUMENTS_AWS_ACCESS_KEY_ID:-test}"
      AWS_SECRET_ACCESS_KEY: "${DOCUMENTS_AWS_SECRET_ACCESS_KEY:-test}"
      AWS_DEFAULT_REGION: "${DOCUMENTS_AWS_DEFAULT_REGION:-eu-west-2}"
      AWS_TEXTRACT_ENDPOINT_URL: "${DOCUMENTS_AWS_TEXTRACT_ENDPOINT_URL:-http://localstack:4566}"
      S3_BUCKET_NAME: "${DOCUMENTS_S3_BUCKET_NAME:-documents-bucket}"
      QNA_SERVICE_URL: "${DOCUMENTS_QNA_SERVICE_URL:-http://qna-service/index}"
      CATEGORIZATION_SERVICE_URL: "${DOCUMENTS_CATEGORIZATION_SERVICE_URL:-http://categorization-service/categorize}"
      TRANSACTIONS_SERVICE_URL: "${DOCUMENTS_TRANSACTIONS_SERVICE_URL:-http://transactions-service/transactions/receipt-drafts}"
      OCR_PROVIDER: "${DOCUMENTS_OCR_PROVIDER:-textract}"
      OCR_REVIEW_CONFIDENCE_THRESHOLD: "${DOCUMENTS_OCR_REVIEW_CONFIDENCE_THRESHOLD:-0.75}"
    networks:
      - default_network

  localstack:
    image: localstack/localstack:latest
    container_name: localstack
    ports:
      - "4566:4566" # Default LocalStack edge port
    environment:
      SERVICES: "${LOCALSTACK_SERVICES:-s3}"
      AWS_DEFAULT_REGION: "${DOCUMENTS_AWS_DEFAULT_REGION:-eu-west-2}"
      AWS_ACCESS_KEY_ID: "${DOCUMENTS_AWS_ACCESS_KEY_ID:-test}"
      AWS_SECRET_ACCESS_KEY: "${DOCUMENTS_AWS_SECRET_ACCESS_KEY:-test}"
    networks:
      - default_network

  aws-cli-setup:
    image: amazon/aws-cli:2.13.25
    container_name: aws-cli-setup
    depends_on:
      - localstack
    environment:
      AWS_ACCESS_KEY_ID: "${DOCUMENTS_AWS_ACCESS_KEY_ID:-test}"
      AWS_SECRET_ACCESS_KEY: "${DOCUMENTS_AWS_SECRET_ACCESS_KEY:-test}"
      AWS_DEFAULT_REGION: "${DOCUMENTS_AWS_DEFAULT_REGION:-eu-west-2}"
    # This command runs once and creates the S3 bucket we need.
    command: >
      sh -c "
        aws s3 mb s3://${DOCUMENTS_S3_BUCKET_NAME:-documents-bucket} --endpoint-url ${DOCUMENTS_AWS_ENDPOINT_URL:-http://localstack:4566} &&
        echo 'Bucket created successfully.'
      "
    networks:
      - default_network

  documents-service:
    build: ./services/documents-service
    container_name: documents-service
    depends_on:
      - postgres
      - localstack
    environment:
      AUTH_SECRET_KEY: "${AUTH_SECRET_KEY:-a_secure_random_string_for_jwt_signing_!@#$%^}"
      DATABASE_URL: "${DOCUMENTS_DATABASE_URL:-postgresql+asyncpg://user:password@postgres/db_documents}"
      AWS_ENDPOINT_URL: "${DOCUMENTS_AWS_ENDPOINT_URL:-http://localstack:4566}" # Point to LocalStack
      AWS_ACCESS_KEY_ID: "${DOCUMENTS_AWS_ACCESS_KEY_ID:-test}"
      AWS_SECRET_ACCESS_KEY: "${DOCUMENTS_AWS_SECRET_ACCESS_KEY:-test}"
      AWS_DEFAULT_REGION: "${DOCUMENTS_AWS_DEFAULT_REGION:-eu-west-2}"
      AWS_TEXTRACT_ENDPOINT_URL: "${DOCUMENTS_AWS_TEXTRACT_ENDPOINT_URL:-http://localstack:4566}"
      S3_BUCKET_NAME: "${DOCUMENTS_S3_BUCKET_NAME:-documents-bucket}"
      CATEGORIZATION_SERVICE_URL: "${DOCUMENTS_CATEGORIZATION_SERVICE_URL:-http://categorization-service/categorize}"
      TRANSACTIONS_SERVICE_URL: "${DOCUMENTS_TRANSACTIONS_SERVICE_URL:-http://transactions-service/transactions/receipt-drafts}"
      OCR_PROVIDER: "${DOCUMENTS_OCR_PROVIDER:-textract}"
      OCR_REVIEW_CONFIDENCE_THRESHOLD: "${DOCUMENTS_OCR_REVIEW_CONFIDENCE_THRESHOLD:-0.75}"
    # No longer need local volume for uploads
    # volumes:
    #   - documents_data:/uploads
    command: sh -c "alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port 80"
    networks:
      - default_network

  tax-engine:
    build: ./services/tax-engine
    container_name: tax-engine
    depends_on:
      - transactions-service
      - integrations-service
      - calendar-service
      - jaeger
    environment:
      AUTH_SECRET_KEY: "${AUTH_SECRET_KEY:-a_secure_random_string_for_jwt_signing_!@#$%^}"
      TRANSACTIONS_SERVICE_URL: "${TAX_TRANSACTIONS_SERVICE_URL:-http://transactions-service/transactions/me}"
      INTEGRATIONS_SERVICE_URL: "${TAX_INTEGRATIONS_SERVICE_URL:-http://integrations-service/integrations/hmrc/submit-tax-return}"
      CALENDAR_SERVICE_URL: "${TAX_CALENDAR_SERVICE_URL:-http://calendar-service/events}"
      OTEL_SERVICE_NAME: "${TAX_OTEL_SERVICE_NAME:-tax-engine}"
      OTEL_EXPORTER_OTLP_ENDPOINT: "${TAX_OTEL_EXPORTER_OTLP_ENDPOINT:-http://jaeger:4317}"
    networks:
      - default_network

  advice-service:
    build: ./services/advice-service
    container_name: advice-service
    depends_on:
      - transactions-service
    environment:
      AUTH_SECRET_KEY: "${AUTH_SECRET_KEY:-a_secure_random_string_for_jwt_signing_!@#$%^}"
      TRANSACTIONS_SERVICE_URL: "${ADVICE_TRANSACTIONS_SERVICE_URL:-http://transactions-service/transactions/me}"
    networks:
      - default_network

  partner-registry:
    build: ./services/partner-registry
    container_name: partner-registry
    depends_on:
      - compliance-service
      - postgres
    environment:
      AUTH_SECRET_KEY: "${AUTH_SECRET_KEY:-a_secure_random_string_for_jwt_signing_!@#$%^}"
      DATABASE_URL: "${PARTNER_DATABASE_URL:-postgresql+asyncpg://user:password@postgres/db_partner}"
      COMPLIANCE_SERVICE_URL: "${PARTNER_COMPLIANCE_SERVICE_URL:-http://compliance-service/audit-events}"
      AUTO_CREATE_SCHEMA: "${PARTNER_AUTO_CREATE_SCHEMA:-true}"
      BILLING_REPORT_ALLOWED_SCOPES: "${PARTNER_BILLING_REPORT_ALLOWED_SCOPES:-billing:read}"
      BILLING_REPORT_ALLOWED_ROLES: "${PARTNER_BILLING_REPORT_ALLOWED_ROLES:-admin,billing_admin}"
      BILLING_INVOICE_DUE_DAYS: "${PARTNER_BILLING_INVOICE_DUE_DAYS:-14}"
    networks:
      - default_network

  integrations-service:
    build: ./services/integrations-service
    container_name: integrations-service
    environment:
      AUTH_SECRET_KEY: "${AUTH_SECRET_KEY:-a_secure_random_string_for_jwt_signing_!@#$%^}"
    networks:
      - default_network

  analytics-service:
    build: ./services/analytics-service
    container_name: analytics-service
    depends_on:
      - transactions-service
      - documents-service
      - user-profile-service
    environment:
      AUTH_SECRET_KEY: "${AUTH_SECRET_KEY:-a_secure_random_string_for_jwt_signing_!@#$%^}"
      TRANSACTIONS_SERVICE_URL: "${ANALYTICS_TRANSACTIONS_SERVICE_URL:-http://transactions-service/transactions/me}"
      DOCUMENTS_SERVICE_URL: "${ANALYTICS_DOCUMENTS_SERVICE_URL:-http://documents-service/documents}"
      USER_PROFILE_SERVICE_URL: "${ANALYTICS_USER_PROFILE_SERVICE_URL:-http://user-profile-service/profiles/me}"
    networks:
      - default_network

  agent-service:
    build: ./services/agent-service
    container_name: agent-service
    depends_on:
      - documents-service
      - transactions-service
      - tax-engine
      - redis
    environment:
      AUTH_SECRET_KEY: "${AUTH_SECRET_KEY:-a_secure_random_string_for_jwt_signing_!@#$%^}"
      DOCUMENTS_REVIEW_QUEUE_URL: "${AGENT_DOCUMENTS_REVIEW_QUEUE_URL:-http://documents-service/documents/review-queue}"
      DOCUMENTS_REVIEW_UPDATE_URL_TEMPLATE: "${AGENT_DOCUMENTS_REVIEW_UPDATE_URL_TEMPLATE:-http://documents-service/documents/{document_id}/review}"
      TRANSACTIONS_RECEIPT_DRAFTS_URL: "${AGENT_TRANSACTIONS_RECEIPT_DRAFTS_URL:-http://transactions-service/transactions/receipt-drafts/unmatched}"
      TRANSACTIONS_RECONCILE_URL_TEMPLATE: "${AGENT_TRANSACTIONS_RECONCILE_URL_TEMPLATE:-http://transactions-service/transactions/receipt-drafts/{draft_transaction_id}/reconcile}"
      TRANSACTIONS_IGNORE_URL_TEMPLATE: "${AGENT_TRANSACTIONS_IGNORE_URL_TEMPLATE:-http://transactions-service/transactions/receipt-drafts/{draft_transaction_id}/ignore}"
      TRANSACTIONS_ME_URL: "${AGENT_TRANSACTIONS_ME_URL:-http://transactions-service/transactions/me}"
      TAX_ENGINE_CALCULATE_URL: "${AGENT_TAX_ENGINE_CALCULATE_URL:-http://tax-engine/calculate}"
      TAX_CALCULATE_AND_SUBMIT_URL: "${AGENT_TAX_ENGINE_CALCULATE_AND_SUBMIT_URL:-http://tax-engine/calculate-and-submit}"
      AGENT_DEFAULT_TAX_LOOKBACK_DAYS: "${AGENT_DEFAULT_TAX_LOOKBACK_DAYS:-365}"
      AGENT_REDIS_URL: "${AGENT_REDIS_URL:-redis://redis:6379/0}"
      AGENT_SESSION_TTL_SECONDS: "${AGENT_SESSION_TTL_SECONDS:-86400}"
      AGENT_CONFIRMATION_TOKEN_TTL_SECONDS: "${AGENT_CONFIRMATION_TOKEN_TTL_SECONDS:-900}"
      AGENT_AUDIT_MAX_EVENTS: "${AGENT_AUDIT_MAX_EVENTS:-500}"
      AGENT_AUDIT_TTL_SECONDS: "${AGENT_AUDIT_TTL_SECONDS:-604800}"
    networks:
      - default_network

  localization-service:
    build: ./services/localization-service
    container_name: localization-service
    environment:
      LOCALIZATION_CATALOG_DIR: "${LOCALIZATION_CATALOG_DIR:-/code/catalogs}"
    networks:
      - default_network

  categorization-service:
    build: ./services/categorization-service
    container_name: categorization-service
    networks:
      - default_network

  prometheus:
    image: prom/prometheus:v2.47.2
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
    networks:
      - default_network

  qna-service:
    build: ./services/qna-service
    container_name: qna-service
    depends_on:
      - weaviate
    environment:
      AUTH_SECRET_KEY: "${AUTH_SECRET_KEY:-a_secure_random_string_for_jwt_signing_!@#$%^}"
      WEAVIATE_URL: "${QNA_WEAVIATE_URL:-http://weaviate:8080}"
    networks:
      - default_network

  vault:
    image: hashicorp/vault:1.15
    container_name: vault
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: "${VAULT_DEV_ROOT_TOKEN_ID:-dev-root-token}"
      VAULT_DEV_LISTEN_ADDRESS: "${VAULT_DEV_LISTEN_ADDRESS:-0.0.0.0:8200}"
    cap_add:
      - IPC_LOCK
    command: "server -dev"
    networks:
      - default_network

  grafana:
    image: grafana/grafana:10.1.5
    container_name: grafana
    ports:
      - "3001:3000" # Changed to 3001 to avoid conflict with web-portal
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus
      - loki
    networks:
      - default_network

  loki:
    image: grafana/loki:2.9.0
    container_name: loki
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - default_network

  promtail:
    image: grafana/promtail:2.9.0
    container_name: promtail
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers # Access to Docker container logs
      - ./promtail-config.yml:/etc/promtail/config.yml
    command: -config.file=/etc/promtail/config.yml
    networks:
      - default_network

  jaeger:
    image: jaegertracing/all-in-one:1.53
    container_name: jaeger
    ports:
      - "6831:6831/udp" # Agent
      - "16686:16686" # UI
      - "4317:4317"   # OTLP gRPC
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    networks:
      - default_network

  calendar-service:
    build: ./services/calendar-service
    container_name: calendar-service
    networks:
      - default_network

  weaviate:
    image: cr.weaviate.io/semitechnologies/weaviate:1.23.7
    container_name: weaviate
    ports:
      - "8080:8080"
    restart: on-failure:0
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'
      DEFAULT_VECTORIZER_MODULE: 'none' # We will generate vectors ourselves
      CLUSTER_HOSTNAME: 'node1'
    networks:
      - default_network

volumes:
  postgres_data:

networks:
  default_network:
    driver: bridge
