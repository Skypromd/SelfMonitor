openapi: 3.0.3
info:
  title: Integrations Service
  description: >-
    Acts as a facade for connecting to external third-party APIs like HMRC (for
    tax submissions) or Xero (for accounting).
  version: 1.0.0
paths:
  /integrations/hmrc/submit-tax-return:
    post:
      summary: Submit a tax return to HMRC
      tags:
        - Integrations
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HMRCSubmissionRequest'
      responses:
        '202':
          description: Submission accepted by HMRC.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmissionStatus'
        '400':
          description: Invalid submission data.
        '502':
          description: Bad Gateway - Error communicating with the external service.
  /integrations/hmrc/mtd/quarterly-update/spec:
    get:
      summary: Get required HMRC MTD quarterly report format
      tags:
        - Integrations
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current quarterly report contract requirements.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HMRCMTDQuarterlyReportSpec'
  /integrations/hmrc/mtd/quarterly-update:
    post:
      summary: Submit HMRC MTD quarterly update directly
      tags:
        - Integrations
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HMRCMTDQuarterlySubmissionRequest'
      responses:
        '202':
          description: Quarterly update accepted for HMRC processing.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HMRCMTDQuarterlySubmissionStatus'
        '400':
          description: Invalid quarterly report shape or period alignment.
        '502':
          description: Bad Gateway - Error communicating with the external service.
  /integrations/hmrc/mtd/submission-slo:
    get:
      summary: Get rolling HMRC MTD submission SLO snapshot
      tags:
        - Integrations
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current rolling submission reliability and latency metrics.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HMRCMTDSubmissionSLOSnapshot'
  /integrations/hmrc/mtd/operational-readiness:
    get:
      summary: Get HMRC direct-submission operational readiness status
      tags:
        - Integrations
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Operational readiness checks for direct HMRC flow.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HMRCMTDOperationalReadiness'

components:
  schemas:
    HMRCSubmissionRequest:
      type: object
      properties:
        tax_period_start:
          type: string
          format: date
        tax_period_end:
          type: string
          format: date
        tax_due:
          type: number
          format: float
      required:
        - tax_period_start
        - tax_period_end
        - tax_due
    SubmissionStatus:
      type: object
      properties:
        submission_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, completed, failed]
        message:
          type: string
          example: 'Your submission has been received and is being processed.'
      required:
        - submission_id
        - status
        - message
    HMRCMTDBusinessIdentity:
      type: object
      properties:
        taxpayer_ref:
          type: string
        business_name:
          type: string
        accounting_method:
          type: string
          enum: [cash, traditional]
      required:
        - taxpayer_ref
        - business_name
        - accounting_method
    HMRCMTDQuarterlyPeriod:
      type: object
      properties:
        tax_year_start:
          type: string
          format: date
        tax_year_end:
          type: string
          format: date
        quarter:
          type: string
          enum: [Q1, Q2, Q3, Q4]
        period_start:
          type: string
          format: date
        period_end:
          type: string
          format: date
        due_date:
          type: string
          format: date
      required:
        - tax_year_start
        - tax_year_end
        - quarter
        - period_start
        - period_end
        - due_date
    HMRCMTDFinancials:
      type: object
      properties:
        turnover:
          type: number
          format: float
        allowable_expenses:
          type: number
          format: float
        taxable_profit:
          type: number
          format: float
        estimated_tax_due:
          type: number
          format: float
        currency:
          type: string
          enum: [GBP]
      required:
        - turnover
        - allowable_expenses
        - taxable_profit
        - estimated_tax_due
        - currency
    HMRCCategorySummaryItem:
      type: object
      properties:
        category:
          type: string
        total_amount:
          type: number
          format: float
        taxable_amount:
          type: number
          format: float
      required:
        - category
        - total_amount
        - taxable_amount
    HMRCMTDQuarterlyReport:
      type: object
      properties:
        schema_version:
          type: string
          enum: [hmrc-mtd-itsa-quarterly-v1]
        jurisdiction:
          type: string
          enum: [UK]
        policy_code:
          type: string
        generated_at:
          type: string
          format: date-time
        business:
          $ref: '#/components/schemas/HMRCMTDBusinessIdentity'
        period:
          $ref: '#/components/schemas/HMRCMTDQuarterlyPeriod'
        financials:
          $ref: '#/components/schemas/HMRCMTDFinancials'
        category_summary:
          type: array
          items:
            $ref: '#/components/schemas/HMRCCategorySummaryItem'
        declaration:
          type: string
          enum: [true_and_complete]
      required:
        - schema_version
        - jurisdiction
        - policy_code
        - generated_at
        - business
        - period
        - financials
        - category_summary
        - declaration
    HMRCMTDQuarterlySubmissionRequest:
      type: object
      properties:
        report:
          $ref: '#/components/schemas/HMRCMTDQuarterlyReport'
        submission_channel:
          type: string
          enum: [api, agent_copilot, manual]
        correlation_id:
          type: string
          nullable: true
      required:
        - report
        - submission_channel
    HMRCMTDQuarterlySubmissionStatus:
      type: object
      properties:
        submission_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, completed, failed]
        message:
          type: string
        submission_type:
          type: string
          enum: [mtd_quarterly_update]
        hmrc_receipt_reference:
          type: string
        hmrc_endpoint:
          type: string
        transmission_mode:
          type: string
          enum: [simulated, direct]
        hmrc_status_code:
          type: integer
          nullable: true
      required:
        - submission_id
        - status
        - message
        - submission_type
        - hmrc_receipt_reference
        - hmrc_endpoint
        - transmission_mode
    HMRCMTDQuarterlyReportSpec:
      type: object
      properties:
        schema_version:
          type: string
          enum: [hmrc-mtd-itsa-quarterly-v1]
        required_sections:
          type: array
          items:
            type: string
        required_period_alignment:
          type: string
        required_declaration:
          type: string
        notes:
          type: array
          items:
            type: string
      required:
        - schema_version
        - required_sections
        - required_period_alignment
        - required_declaration
        - notes
    HMRCMTDSubmissionSLOSnapshot:
      type: object
      properties:
        generated_at:
          type: string
          format: date-time
        window_size:
          type: integer
        total_submissions:
          type: integer
        successful_submissions:
          type: integer
        failed_submissions:
          type: integer
        fallback_submissions:
          type: integer
        direct_mode_submissions:
          type: integer
        simulated_mode_submissions:
          type: integer
        success_rate_percent:
          type: number
          format: float
        p95_latency_ms:
          type: number
          format: float
        success_rate_target_percent:
          type: number
          format: float
        p95_latency_target_ms:
          type: number
          format: float
        success_rate_alert:
          type: boolean
        latency_alert:
          type: boolean
        note:
          type: string
      required:
        - generated_at
        - window_size
        - total_submissions
        - successful_submissions
        - failed_submissions
        - fallback_submissions
        - direct_mode_submissions
        - simulated_mode_submissions
        - success_rate_percent
        - p95_latency_ms
        - success_rate_target_percent
        - p95_latency_target_ms
        - success_rate_alert
        - latency_alert
        - note
    HMRCMTDOperationalReadiness:
      type: object
      properties:
        generated_at:
          type: string
          format: date-time
        direct_submission_enabled:
          type: boolean
        fallback_to_simulation_enabled:
          type: boolean
        oauth_credentials_configured:
          type: boolean
        credential_rotation_date:
          type: string
          format: date
          nullable: true
        credential_age_days:
          type: integer
          nullable: true
        credential_rotation_max_age_days:
          type: integer
        credential_rotation_overdue:
          type: boolean
        readiness_band:
          type: string
          enum: [ready, degraded, not_ready]
        notes:
          type: array
          items:
            type: string
      required:
        - generated_at
        - direct_submission_enabled
        - fallback_to_simulation_enabled
        - oauth_credentials_configured
        - credential_rotation_max_age_days
        - credential_rotation_overdue
        - readiness_band
        - notes

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
