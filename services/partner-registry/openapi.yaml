openapi: 3.0.3
info:
  title: Partner Registry Service
  description: Manages partner catalog and monetization handoff leads.
  version: 1.0.0

paths:
  /partners:
    get:
      summary: List available partners
      tags:
        - Partners
      parameters:
        - name: service_type
          in: query
          required: false
          schema:
            type: string
            example: mortgage_advice
          description: Filter partners by offered service.
      responses:
        "200":
          description: List of partners.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Partner"

  /partners/{partner_id}:
    get:
      summary: Get partner details
      tags:
        - Partners
      parameters:
        - name: partner_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Partner details.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Partner"
        "404":
          description: Partner not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /partners/{partner_id}/handoff:
    post:
      summary: Initiate partner handoff and create monetization lead
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: partner_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "202":
          description: Handoff handled (created or deduplicated).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HandoffResponse"
        "404":
          description: Partner not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /partners/{partner_id}/pricing:
    patch:
      summary: Update partner pricing used for billing calculations
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: partner_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PartnerPricingUpdateRequest"
      responses:
        "200":
          description: Updated partner pricing.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Partner"
        "404":
          description: Partner not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /leads:
    get:
      summary: List handoff leads for operations
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: partner_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          required: false
          schema:
            $ref: "#/components/schemas/LeadStatus"
        - name: user_id
          in: query
          required: false
          schema:
            type: string
        - name: start_date
          in: query
          required: false
          schema:
            type: string
            format: date
        - name: end_date
          in: query
          required: false
          schema:
            type: string
            format: date
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
            default: 50
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        "200":
          description: Paginated operational lead list.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LeadListResponse"
        "400":
          description: Invalid query parameters or date range.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /billing/invoices/generate:
    post:
      summary: Generate immutable billing invoice snapshot
      tags:
        - Monetization
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BillingInvoiceGenerateRequest"
      responses:
        "201":
          description: Invoice generated.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BillingInvoiceDetail"
        "400":
          description: Invalid request payload or statuses.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /billing/invoices:
    get:
      summary: List generated billing invoices
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          required: false
          schema:
            $ref: "#/components/schemas/BillingInvoiceStatus"
        - name: partner_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
            default: 50
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        "200":
          description: Paginated invoice list.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BillingInvoiceListResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /billing/invoices/{invoice_id}:
    get:
      summary: Get billing invoice details
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: invoice_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Full invoice details and line items.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BillingInvoiceDetail"
        "404":
          description: Invoice not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /billing/invoices/{invoice_id}/pdf:
    get:
      summary: Download invoice as PDF document
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: invoice_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: PDF invoice export.
          content:
            application/pdf:
              schema:
                type: string
                format: binary
        "404":
          description: Invoice not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /billing/invoices/{invoice_id}/accounting.csv:
    get:
      summary: Export invoice in accounting-friendly CSV format
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: invoice_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: target
          in: query
          required: false
          schema:
            $ref: "#/components/schemas/AccountingExportTarget"
          description: CSV mapping profile for the target accounting platform.
      responses:
        "200":
          description: Accounting CSV export.
          content:
            text/csv:
              schema:
                type: string
                format: binary
        "404":
          description: Invoice not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /billing/invoices/{invoice_id}/status:
    patch:
      summary: Update billing invoice status lifecycle
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: invoice_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BillingInvoiceStatusUpdateRequest"
      responses:
        "200":
          description: Invoice status updated.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BillingInvoiceDetail"
        "404":
          description: Invoice not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Invalid status transition.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /leads/billing:
    get:
      summary: Get billing report with monetary totals (GBP)
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: format
          in: query
          required: false
          schema:
            type: string
            enum:
              - json
              - csv
            default: json
          description: Response format (`json` by default, `csv` for export).
        - name: partner_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Optional partner filter.
        - name: start_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Inclusive start date (UTC).
        - name: end_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Inclusive end date (UTC).
        - name: statuses
          in: query
          required: false
          schema:
            type: array
            items:
              $ref: "#/components/schemas/LeadStatus"
          style: form
          explode: true
          description: Billing statuses to include (`qualified` and/or `converted`).
      responses:
        "200":
          description: Billing report.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BillingReportResponse"
            text/csv:
              schema:
                type: string
                format: binary
        "400":
          description: Invalid date range or statuses.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /leads/billing.csv:
    get:
      summary: Export billing report as CSV
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: partner_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Optional partner filter.
        - name: start_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Inclusive start date (UTC).
        - name: end_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Inclusive end date (UTC).
        - name: statuses
          in: query
          required: false
          schema:
            type: array
            items:
              $ref: "#/components/schemas/LeadStatus"
          style: form
          explode: true
          description: Billing statuses to include (`qualified` and/or `converted`).
      responses:
        "200":
          description: CSV billing report.
          content:
            text/csv:
              schema:
                type: string
                format: binary
        "400":
          description: Invalid date range or statuses.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /leads/report:
    get:
      summary: Get lead report for Pay-Per-Lead billing
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: format
          in: query
          required: false
          schema:
            type: string
            enum:
              - json
              - csv
            default: json
          description: Response format (`json` by default, `csv` for export).
        - name: partner_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Optional partner filter.
        - name: start_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Inclusive start date (UTC).
        - name: end_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Inclusive end date (UTC).
        - name: billable_only
          in: query
          required: false
          schema:
            type: boolean
            default: true
          description: When true (default), includes only billable (`qualified`) leads unless `statuses` is explicitly provided.
        - name: statuses
          in: query
          required: false
          schema:
            type: array
            items:
              $ref: "#/components/schemas/LeadStatus"
          style: form
          explode: true
          description: Optional explicit status filter (overrides `billable_only` behavior).
      responses:
        "200":
          description: Aggregated report of leads.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LeadReportResponse"
            text/csv:
              schema:
                type: string
                format: binary
        "400":
          description: Invalid date range.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /leads/report.csv:
    get:
      summary: Export lead report as CSV
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: partner_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Optional partner filter.
        - name: start_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Inclusive start date (UTC).
        - name: end_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Inclusive end date (UTC).
        - name: billable_only
          in: query
          required: false
          schema:
            type: boolean
            default: true
          description: When true (default), includes only billable (`qualified`) leads unless `statuses` is explicitly provided.
        - name: statuses
          in: query
          required: false
          schema:
            type: array
            items:
              $ref: "#/components/schemas/LeadStatus"
          style: form
          explode: true
          description: Optional explicit status filter (overrides `billable_only` behavior).
      responses:
        "200":
          description: CSV report for billing/export.
          content:
            text/csv:
              schema:
                type: string
                format: binary
        "400":
          description: Invalid date range.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /investor/seed-readiness:
    get:
      summary: Get seed-readiness KPI snapshot for investor tracking
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: period_months
          in: query
          required: false
          schema:
            type: integer
            minimum: 3
            maximum: 24
            default: 6
          description: Monthly history length used for MRR trend analysis.
      responses:
        "200":
          description: Seed-readiness KPI snapshot.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SeedReadinessResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /investor/pmf-evidence:
    get:
      summary: Get PMF activation and 30/60/90 retention cohorts
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: cohort_months
          in: query
          required: false
          schema:
            type: integer
            minimum: 3
            maximum: 24
            default: 6
          description: Number of monthly cohorts included in PMF evidence snapshot.
        - name: activation_window_days
          in: query
          required: false
          schema:
            type: integer
            minimum: 7
            maximum: 60
            default: 30
          description: Activation window measured from first-seen user activity.
        - name: as_of_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Optional snapshot date for backtesting PMF trend calculations.
      responses:
        "200":
          description: PMF evidence snapshot with activation and retention cohorts.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PMFEvidenceResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /leads/{lead_id}/status:
    patch:
      summary: Update handoff lead lifecycle status
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: lead_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LeadStatusUpdateRequest"
      responses:
        "200":
          description: Lead status updated successfully.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LeadStatusUpdateResponse"
        "404":
          description: Lead not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Invalid status transition.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  schemas:
    LeadStatus:
      type: string
      enum:
        - initiated
        - qualified
        - rejected
        - converted

    Partner:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: SafeFuture Financial Advisors
        description:
          type: string
          example: Independent financial advisors regulated by the FCA.
        services_offered:
          type: array
          items:
            type: string
          example:
            - pension_advice
            - investment_management
        website:
          type: string
          format: uri
          example: https://www.safefuture.example.com
        qualified_lead_fee_gbp:
          type: number
          format: float
          example: 18.0
        converted_lead_fee_gbp:
          type: number
          format: float
          example: 55.0
      required:
        - id
        - name
        - description
        - services_offered
        - website
        - qualified_lead_fee_gbp
        - converted_lead_fee_gbp

    HandoffResponse:
      type: object
      properties:
        message:
          type: string
          example: Handoff to SafeFuture Financial Advisors initiated.
        lead_id:
          type: string
          format: uuid
        audit_event_id:
          type: string
          nullable: true
          example: 1473f17b-56e9-43e9-b8d8-3cd5a53efed2
        duplicated:
          type: boolean
          example: false
      required:
        - message
        - lead_id
        - duplicated

    LeadReportByPartner:
      type: object
      properties:
        partner_id:
          type: string
          format: uuid
        partner_name:
          type: string
          example: HomePath Mortgages
        leads_count:
          type: integer
          example: 12
        unique_users:
          type: integer
          example: 10
      required:
        - partner_id
        - partner_name
        - leads_count
        - unique_users

    LeadReportResponse:
      type: object
      properties:
        period_start:
          type: string
          format: date
          nullable: true
        period_end:
          type: string
          format: date
          nullable: true
        total_leads:
          type: integer
          example: 42
        unique_users:
          type: integer
          example: 35
        by_partner:
          type: array
          items:
            $ref: "#/components/schemas/LeadReportByPartner"
      required:
        - total_leads
        - unique_users
        - by_partner

    BillingReportByPartner:
      type: object
      properties:
        partner_id:
          type: string
          format: uuid
        partner_name:
          type: string
          example: SafeFuture Financial Advisors
        qualified_leads:
          type: integer
          example: 12
        converted_leads:
          type: integer
          example: 3
        unique_users:
          type: integer
          example: 10
        qualified_lead_fee_gbp:
          type: number
          format: float
          example: 18.0
        converted_lead_fee_gbp:
          type: number
          format: float
          example: 55.0
        amount_gbp:
          type: number
          format: float
          example: 381.0
      required:
        - partner_id
        - partner_name
        - qualified_leads
        - converted_leads
        - unique_users
        - qualified_lead_fee_gbp
        - converted_lead_fee_gbp
        - amount_gbp

    BillingReportResponse:
      type: object
      properties:
        period_start:
          type: string
          format: date
          nullable: true
        period_end:
          type: string
          format: date
          nullable: true
        currency:
          type: string
          example: GBP
        total_leads:
          type: integer
          example: 15
        qualified_leads:
          type: integer
          example: 12
        converted_leads:
          type: integer
          example: 3
        unique_users:
          type: integer
          example: 10
        total_amount_gbp:
          type: number
          format: float
          example: 381.0
        by_partner:
          type: array
          items:
            $ref: "#/components/schemas/BillingReportByPartner"
      required:
        - currency
        - total_leads
        - qualified_leads
        - converted_leads
        - unique_users
        - total_amount_gbp
        - by_partner

    SeedMRRPoint:
      type: object
      properties:
        month:
          type: string
          example: "2026-02"
        mrr_gbp:
          type: number
          format: float
          example: 1234.56
      required:
        - month
        - mrr_gbp

    SeedReadinessResponse:
      type: object
      properties:
        generated_at:
          type: string
          format: date-time
        period_months:
          type: integer
          example: 6
        current_month_mrr_gbp:
          type: number
          format: float
        previous_month_mrr_gbp:
          type: number
          format: float
        mrr_growth_percent:
          type: number
          format: float
        rolling_3_month_avg_mrr_gbp:
          type: number
          format: float
        paid_invoice_rate_percent:
          type: number
          format: float
        active_invoice_count:
          type: integer
        leads_last_90d:
          type: integer
        qualified_last_90d:
          type: integer
        converted_last_90d:
          type: integer
        qualification_rate_percent:
          type: number
          format: float
        conversion_rate_percent:
          type: number
          format: float
        readiness_score_percent:
          type: number
          format: float
        readiness_band:
          type: string
          enum:
            - early
            - progressing
            - investable
        next_actions:
          type: array
          items:
            type: string
        monthly_mrr_series:
          type: array
          items:
            $ref: "#/components/schemas/SeedMRRPoint"
      required:
        - generated_at
        - period_months
        - current_month_mrr_gbp
        - previous_month_mrr_gbp
        - mrr_growth_percent
        - rolling_3_month_avg_mrr_gbp
        - paid_invoice_rate_percent
        - active_invoice_count
        - leads_last_90d
        - qualified_last_90d
        - converted_last_90d
        - qualification_rate_percent
        - conversion_rate_percent
        - readiness_score_percent
        - readiness_band
        - next_actions
        - monthly_mrr_series

    PMFMonthlyCohortPoint:
      type: object
      properties:
        cohort_month:
          type: string
          example: "2026-01"
        new_users:
          type: integer
        activated_users:
          type: integer
        activation_rate_percent:
          type: number
          format: float
        eligible_users_30d:
          type: integer
        retained_users_30d:
          type: integer
        retention_rate_30d_percent:
          type: number
          format: float
        eligible_users_60d:
          type: integer
        retained_users_60d:
          type: integer
        retention_rate_60d_percent:
          type: number
          format: float
        eligible_users_90d:
          type: integer
        retained_users_90d:
          type: integer
        retention_rate_90d_percent:
          type: number
          format: float
      required:
        - cohort_month
        - new_users
        - activated_users
        - activation_rate_percent
        - eligible_users_30d
        - retained_users_30d
        - retention_rate_30d_percent
        - eligible_users_60d
        - retained_users_60d
        - retention_rate_60d_percent
        - eligible_users_90d
        - retained_users_90d
        - retention_rate_90d_percent

    PMFEvidenceResponse:
      type: object
      properties:
        generated_at:
          type: string
          format: date-time
        as_of_date:
          type: string
          format: date
        cohort_months:
          type: integer
        activation_window_days:
          type: integer
        total_new_users:
          type: integer
        activated_users:
          type: integer
        activation_rate_percent:
          type: number
          format: float
        eligible_users_30d:
          type: integer
        retained_users_30d:
          type: integer
        retention_rate_30d_percent:
          type: number
          format: float
        eligible_users_60d:
          type: integer
        retained_users_60d:
          type: integer
        retention_rate_60d_percent:
          type: number
          format: float
        eligible_users_90d:
          type: integer
        retained_users_90d:
          type: integer
        retention_rate_90d_percent:
          type: number
          format: float
        pmf_band:
          type: string
          enum:
            - early
            - emerging
            - pmf_confirmed
        notes:
          type: array
          items:
            type: string
        monthly_cohorts:
          type: array
          items:
            $ref: "#/components/schemas/PMFMonthlyCohortPoint"
      required:
        - generated_at
        - as_of_date
        - cohort_months
        - activation_window_days
        - total_new_users
        - activated_users
        - activation_rate_percent
        - eligible_users_30d
        - retained_users_30d
        - retention_rate_30d_percent
        - eligible_users_60d
        - retained_users_60d
        - retention_rate_60d_percent
        - eligible_users_90d
        - retained_users_90d
        - retention_rate_90d_percent
        - pmf_band
        - notes
        - monthly_cohorts

    PartnerPricingUpdateRequest:
      type: object
      properties:
        qualified_lead_fee_gbp:
          type: number
          format: float
          minimum: 0
        converted_lead_fee_gbp:
          type: number
          format: float
          minimum: 0
      required:
        - qualified_lead_fee_gbp
        - converted_lead_fee_gbp

    LeadListItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
        partner_id:
          type: string
          format: uuid
        partner_name:
          type: string
        status:
          $ref: "#/components/schemas/LeadStatus"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required:
        - id
        - user_id
        - partner_id
        - partner_name
        - status
        - created_at
        - updated_at

    LeadListResponse:
      type: object
      properties:
        total:
          type: integer
          example: 124
        items:
          type: array
          items:
            $ref: "#/components/schemas/LeadListItem"
      required:
        - total
        - items

    BillingInvoiceStatus:
      type: string
      enum:
        - generated
        - issued
        - paid
        - void

    AccountingExportTarget:
      type: string
      enum:
        - xero
        - quickbooks

    BillingInvoiceGenerateRequest:
      type: object
      properties:
        partner_id:
          type: string
          format: uuid
          nullable: true
        start_date:
          type: string
          format: date
          nullable: true
        end_date:
          type: string
          format: date
          nullable: true
        statuses:
          type: array
          items:
            $ref: "#/components/schemas/LeadStatus"

    BillingInvoiceLine:
      type: object
      properties:
        partner_id:
          type: string
          format: uuid
        partner_name:
          type: string
        qualified_leads:
          type: integer
        converted_leads:
          type: integer
        unique_users:
          type: integer
        qualified_lead_fee_gbp:
          type: number
          format: float
        converted_lead_fee_gbp:
          type: number
          format: float
        amount_gbp:
          type: number
          format: float
      required:
        - partner_id
        - partner_name
        - qualified_leads
        - converted_leads
        - unique_users
        - qualified_lead_fee_gbp
        - converted_lead_fee_gbp
        - amount_gbp

    BillingInvoiceSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        invoice_number:
          type: string
          example: INV-202602-000123
        period_start:
          type: string
          format: date
          nullable: true
        period_end:
          type: string
          format: date
          nullable: true
        due_date:
          type: string
          format: date
        currency:
          type: string
          example: GBP
        status:
          $ref: "#/components/schemas/BillingInvoiceStatus"
        total_amount_gbp:
          type: number
          format: float
        created_at:
          type: string
          format: date-time
      required:
        - id
        - invoice_number
        - due_date
        - currency
        - status
        - total_amount_gbp
        - created_at

    BillingInvoiceDetail:
      allOf:
        - $ref: "#/components/schemas/BillingInvoiceSummary"
        - type: object
          properties:
            generated_by_user_id:
              type: string
            partner_id:
              type: string
              format: uuid
              nullable: true
            statuses:
              type: array
              items:
                $ref: "#/components/schemas/LeadStatus"
            updated_at:
              type: string
              format: date-time
            lines:
              type: array
              items:
                $ref: "#/components/schemas/BillingInvoiceLine"
          required:
            - generated_by_user_id
            - statuses
            - updated_at
            - lines

    BillingInvoiceListResponse:
      type: object
      properties:
        total:
          type: integer
        items:
          type: array
          items:
            $ref: "#/components/schemas/BillingInvoiceSummary"
      required:
        - total
        - items

    BillingInvoiceStatusUpdateRequest:
      type: object
      properties:
        status:
          $ref: "#/components/schemas/BillingInvoiceStatus"
      required:
        - status

    LeadStatusUpdateRequest:
      type: object
      properties:
        status:
          $ref: "#/components/schemas/LeadStatus"
      required:
        - status

    LeadStatusUpdateResponse:
      type: object
      properties:
        lead_id:
          type: string
          format: uuid
        status:
          $ref: "#/components/schemas/LeadStatus"
        updated_at:
          type: string
          format: date-time
      required:
        - lead_id
        - status
        - updated_at

    ErrorResponse:
      type: object
      properties:
        detail:
          type: string
      required:
        - detail

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
