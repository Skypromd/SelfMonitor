openapi: 3.0.3
info:
  title: Partner Registry Service
  description: Manages partner catalog and monetization handoff leads.
  version: 1.0.0

paths:
  /partners:
    get:
      summary: List available partners
      tags:
        - Partners
      parameters:
        - name: service_type
          in: query
          required: false
          schema:
            type: string
            example: mortgage_advice
          description: Filter partners by offered service.
      responses:
        "200":
          description: List of partners.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Partner"

  /partners/{partner_id}:
    get:
      summary: Get partner details
      tags:
        - Partners
      parameters:
        - name: partner_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Partner details.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Partner"
        "404":
          description: Partner not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /partners/{partner_id}/handoff:
    post:
      summary: Initiate partner handoff and create monetization lead
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: partner_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "202":
          description: Handoff handled (created or deduplicated).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HandoffResponse"
        "404":
          description: Partner not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /leads/billing:
    get:
      summary: Get billing report with monetary totals (GBP)
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: format
          in: query
          required: false
          schema:
            type: string
            enum:
              - json
              - csv
            default: json
          description: Response format (`json` by default, `csv` for export).
        - name: partner_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Optional partner filter.
        - name: start_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Inclusive start date (UTC).
        - name: end_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Inclusive end date (UTC).
        - name: statuses
          in: query
          required: false
          schema:
            type: array
            items:
              $ref: "#/components/schemas/LeadStatus"
          style: form
          explode: true
          description: Billing statuses to include (`qualified` and/or `converted`).
      responses:
        "200":
          description: Billing report.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BillingReportResponse"
            text/csv:
              schema:
                type: string
                format: binary
        "400":
          description: Invalid date range or statuses.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /leads/billing.csv:
    get:
      summary: Export billing report as CSV
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: partner_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Optional partner filter.
        - name: start_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Inclusive start date (UTC).
        - name: end_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Inclusive end date (UTC).
        - name: statuses
          in: query
          required: false
          schema:
            type: array
            items:
              $ref: "#/components/schemas/LeadStatus"
          style: form
          explode: true
          description: Billing statuses to include (`qualified` and/or `converted`).
      responses:
        "200":
          description: CSV billing report.
          content:
            text/csv:
              schema:
                type: string
                format: binary
        "400":
          description: Invalid date range or statuses.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /leads/report:
    get:
      summary: Get lead report for Pay-Per-Lead billing
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: format
          in: query
          required: false
          schema:
            type: string
            enum:
              - json
              - csv
            default: json
          description: Response format (`json` by default, `csv` for export).
        - name: partner_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Optional partner filter.
        - name: start_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Inclusive start date (UTC).
        - name: end_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Inclusive end date (UTC).
        - name: billable_only
          in: query
          required: false
          schema:
            type: boolean
            default: true
          description: When true (default), includes only billable (`qualified`) leads unless `statuses` is explicitly provided.
        - name: statuses
          in: query
          required: false
          schema:
            type: array
            items:
              $ref: "#/components/schemas/LeadStatus"
          style: form
          explode: true
          description: Optional explicit status filter (overrides `billable_only` behavior).
      responses:
        "200":
          description: Aggregated report of leads.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LeadReportResponse"
            text/csv:
              schema:
                type: string
                format: binary
        "400":
          description: Invalid date range.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /leads/report.csv:
    get:
      summary: Export lead report as CSV
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: partner_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Optional partner filter.
        - name: start_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Inclusive start date (UTC).
        - name: end_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Inclusive end date (UTC).
        - name: billable_only
          in: query
          required: false
          schema:
            type: boolean
            default: true
          description: When true (default), includes only billable (`qualified`) leads unless `statuses` is explicitly provided.
        - name: statuses
          in: query
          required: false
          schema:
            type: array
            items:
              $ref: "#/components/schemas/LeadStatus"
          style: form
          explode: true
          description: Optional explicit status filter (overrides `billable_only` behavior).
      responses:
        "200":
          description: CSV report for billing/export.
          content:
            text/csv:
              schema:
                type: string
                format: binary
        "400":
          description: Invalid date range.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /leads/{lead_id}/status:
    patch:
      summary: Update handoff lead lifecycle status
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: lead_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LeadStatusUpdateRequest"
      responses:
        "200":
          description: Lead status updated successfully.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LeadStatusUpdateResponse"
        "404":
          description: Lead not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Invalid status transition.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  schemas:
    LeadStatus:
      type: string
      enum:
        - initiated
        - qualified
        - rejected
        - converted

    Partner:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: SafeFuture Financial Advisors
        description:
          type: string
          example: Independent financial advisors regulated by the FCA.
        services_offered:
          type: array
          items:
            type: string
          example:
            - pension_advice
            - investment_management
        website:
          type: string
          format: uri
          example: https://www.safefuture.example.com
        qualified_lead_fee_gbp:
          type: number
          format: float
          example: 18.0
        converted_lead_fee_gbp:
          type: number
          format: float
          example: 55.0
      required:
        - id
        - name
        - description
        - services_offered
        - website
        - qualified_lead_fee_gbp
        - converted_lead_fee_gbp

    HandoffResponse:
      type: object
      properties:
        message:
          type: string
          example: Handoff to SafeFuture Financial Advisors initiated.
        lead_id:
          type: string
          format: uuid
        audit_event_id:
          type: string
          nullable: true
          example: 1473f17b-56e9-43e9-b8d8-3cd5a53efed2
        duplicated:
          type: boolean
          example: false
      required:
        - message
        - lead_id
        - duplicated

    LeadReportByPartner:
      type: object
      properties:
        partner_id:
          type: string
          format: uuid
        partner_name:
          type: string
          example: HomePath Mortgages
        leads_count:
          type: integer
          example: 12
        unique_users:
          type: integer
          example: 10
      required:
        - partner_id
        - partner_name
        - leads_count
        - unique_users

    LeadReportResponse:
      type: object
      properties:
        period_start:
          type: string
          format: date
          nullable: true
        period_end:
          type: string
          format: date
          nullable: true
        total_leads:
          type: integer
          example: 42
        unique_users:
          type: integer
          example: 35
        by_partner:
          type: array
          items:
            $ref: "#/components/schemas/LeadReportByPartner"
      required:
        - total_leads
        - unique_users
        - by_partner

    BillingReportByPartner:
      type: object
      properties:
        partner_id:
          type: string
          format: uuid
        partner_name:
          type: string
          example: SafeFuture Financial Advisors
        qualified_leads:
          type: integer
          example: 12
        converted_leads:
          type: integer
          example: 3
        unique_users:
          type: integer
          example: 10
        qualified_lead_fee_gbp:
          type: number
          format: float
          example: 18.0
        converted_lead_fee_gbp:
          type: number
          format: float
          example: 55.0
        amount_gbp:
          type: number
          format: float
          example: 381.0
      required:
        - partner_id
        - partner_name
        - qualified_leads
        - converted_leads
        - unique_users
        - qualified_lead_fee_gbp
        - converted_lead_fee_gbp
        - amount_gbp

    BillingReportResponse:
      type: object
      properties:
        period_start:
          type: string
          format: date
          nullable: true
        period_end:
          type: string
          format: date
          nullable: true
        currency:
          type: string
          example: GBP
        total_leads:
          type: integer
          example: 15
        qualified_leads:
          type: integer
          example: 12
        converted_leads:
          type: integer
          example: 3
        unique_users:
          type: integer
          example: 10
        total_amount_gbp:
          type: number
          format: float
          example: 381.0
        by_partner:
          type: array
          items:
            $ref: "#/components/schemas/BillingReportByPartner"
      required:
        - currency
        - total_leads
        - qualified_leads
        - converted_leads
        - unique_users
        - total_amount_gbp
        - by_partner

    LeadStatusUpdateRequest:
      type: object
      properties:
        status:
          $ref: "#/components/schemas/LeadStatus"
      required:
        - status

    LeadStatusUpdateResponse:
      type: object
      properties:
        lead_id:
          type: string
          format: uuid
        status:
          $ref: "#/components/schemas/LeadStatus"
        updated_at:
          type: string
          format: date-time
      required:
        - lead_id
        - status
        - updated_at

    ErrorResponse:
      type: object
      properties:
        detail:
          type: string
      required:
        - detail

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
