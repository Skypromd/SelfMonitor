openapi: 3.0.3
info:
  title: Partner Registry Service
  description: Manages partner catalog and monetization handoff leads.
  version: 1.0.0

paths:
  /partners:
    get:
      summary: List available partners
      tags:
        - Partners
      parameters:
        - name: service_type
          in: query
          required: false
          schema:
            type: string
            example: mortgage_advice
          description: Filter partners by offered service.
      responses:
        "200":
          description: List of partners.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Partner"

  /partners/{partner_id}:
    get:
      summary: Get partner details
      tags:
        - Partners
      parameters:
        - name: partner_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Partner details.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Partner"
        "404":
          description: Partner not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /partners/{partner_id}/handoff:
    post:
      summary: Initiate partner handoff and create monetization lead
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: partner_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "202":
          description: Handoff handled (created or deduplicated).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HandoffResponse"
        "404":
          description: Partner not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /partners/{partner_id}/pricing:
    patch:
      summary: Update partner pricing used for billing calculations
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: partner_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PartnerPricingUpdateRequest"
      responses:
        "200":
          description: Updated partner pricing.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Partner"
        "404":
          description: Partner not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /leads:
    get:
      summary: List handoff leads for operations
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: partner_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          required: false
          schema:
            $ref: "#/components/schemas/LeadStatus"
        - name: user_id
          in: query
          required: false
          schema:
            type: string
        - name: start_date
          in: query
          required: false
          schema:
            type: string
            format: date
        - name: end_date
          in: query
          required: false
          schema:
            type: string
            format: date
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
            default: 50
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        "200":
          description: Paginated operational lead list.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LeadListResponse"
        "400":
          description: Invalid query parameters or date range.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /self-employed/invoices:
    post:
      summary: Create client invoice for self-employed user
      tags:
        - Monetization
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SelfEmployedInvoiceCreateRequest"
      responses:
        "201":
          description: Self-employed invoice created.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SelfEmployedInvoiceDetail"
        "400":
          description: Invalid payload.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    get:
      summary: List self-employed invoices for current user
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          required: false
          schema:
            $ref: "#/components/schemas/SelfEmployedInvoiceStatus"
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
            default: 50
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        "200":
          description: Paginated self-employed invoice list.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SelfEmployedInvoiceListResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /self-employed/invoices/{invoice_id}:
    get:
      summary: Get self-employed invoice details
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: invoice_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Full self-employed invoice details.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SelfEmployedInvoiceDetail"
        "404":
          description: Self-employed invoice not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /self-employed/invoices/{invoice_id}/status:
    patch:
      summary: Update self-employed invoice status
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: invoice_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SelfEmployedInvoiceStatusUpdateRequest"
      responses:
        "200":
          description: Updated invoice details.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SelfEmployedInvoiceDetail"
        "404":
          description: Self-employed invoice not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Invalid status transition.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /self-employed/invoices/{invoice_id}/pdf:
    get:
      summary: Download self-employed invoice as PDF
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: invoice_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Invoice PDF.
          content:
            application/pdf:
              schema:
                type: string
                format: binary
        "404":
          description: Self-employed invoice not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /self-employed/invoices/{invoice_id}/csv:
    get:
      summary: Download self-employed invoice as CSV
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: invoice_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Invoice CSV.
          content:
            text/csv:
              schema:
                type: string
                format: binary
        "404":
          description: Self-employed invoice not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /billing/invoices/generate:
    post:
      summary: Generate immutable billing invoice snapshot
      tags:
        - Monetization
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BillingInvoiceGenerateRequest"
      responses:
        "201":
          description: Invoice generated.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BillingInvoiceDetail"
        "400":
          description: Invalid request payload or statuses.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /billing/invoices:
    get:
      summary: List generated billing invoices
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          required: false
          schema:
            $ref: "#/components/schemas/BillingInvoiceStatus"
        - name: partner_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
            default: 50
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        "200":
          description: Paginated invoice list.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BillingInvoiceListResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /billing/invoices/{invoice_id}:
    get:
      summary: Get billing invoice details
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: invoice_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Full invoice details and line items.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BillingInvoiceDetail"
        "404":
          description: Invoice not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /billing/invoices/{invoice_id}/pdf:
    get:
      summary: Download invoice as PDF document
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: invoice_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: PDF invoice export.
          content:
            application/pdf:
              schema:
                type: string
                format: binary
        "404":
          description: Invoice not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /billing/invoices/{invoice_id}/accounting.csv:
    get:
      summary: Export invoice in accounting-friendly CSV format
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: invoice_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: target
          in: query
          required: false
          schema:
            $ref: "#/components/schemas/AccountingExportTarget"
          description: CSV mapping profile for the target accounting platform.
      responses:
        "200":
          description: Accounting CSV export.
          content:
            text/csv:
              schema:
                type: string
                format: binary
        "404":
          description: Invoice not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /billing/invoices/{invoice_id}/status:
    patch:
      summary: Update billing invoice status lifecycle
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: invoice_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BillingInvoiceStatusUpdateRequest"
      responses:
        "200":
          description: Invoice status updated.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BillingInvoiceDetail"
        "404":
          description: Invoice not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Invalid status transition.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /leads/billing:
    get:
      summary: Get billing report with monetary totals (GBP)
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: format
          in: query
          required: false
          schema:
            type: string
            enum:
              - json
              - csv
            default: json
          description: Response format (`json` by default, `csv` for export).
        - name: partner_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Optional partner filter.
        - name: start_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Inclusive start date (UTC).
        - name: end_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Inclusive end date (UTC).
        - name: statuses
          in: query
          required: false
          schema:
            type: array
            items:
              $ref: "#/components/schemas/LeadStatus"
          style: form
          explode: true
          description: Billing statuses to include (`qualified` and/or `converted`).
      responses:
        "200":
          description: Billing report.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BillingReportResponse"
            text/csv:
              schema:
                type: string
                format: binary
        "400":
          description: Invalid date range or statuses.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /leads/billing.csv:
    get:
      summary: Export billing report as CSV
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: partner_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Optional partner filter.
        - name: start_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Inclusive start date (UTC).
        - name: end_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Inclusive end date (UTC).
        - name: statuses
          in: query
          required: false
          schema:
            type: array
            items:
              $ref: "#/components/schemas/LeadStatus"
          style: form
          explode: true
          description: Billing statuses to include (`qualified` and/or `converted`).
      responses:
        "200":
          description: CSV billing report.
          content:
            text/csv:
              schema:
                type: string
                format: binary
        "400":
          description: Invalid date range or statuses.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /leads/report:
    get:
      summary: Get lead report for Pay-Per-Lead billing
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: format
          in: query
          required: false
          schema:
            type: string
            enum:
              - json
              - csv
            default: json
          description: Response format (`json` by default, `csv` for export).
        - name: partner_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Optional partner filter.
        - name: start_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Inclusive start date (UTC).
        - name: end_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Inclusive end date (UTC).
        - name: billable_only
          in: query
          required: false
          schema:
            type: boolean
            default: true
          description: When true (default), includes only billable (`qualified`) leads unless `statuses` is explicitly provided.
        - name: statuses
          in: query
          required: false
          schema:
            type: array
            items:
              $ref: "#/components/schemas/LeadStatus"
          style: form
          explode: true
          description: Optional explicit status filter (overrides `billable_only` behavior).
      responses:
        "200":
          description: Aggregated report of leads.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LeadReportResponse"
            text/csv:
              schema:
                type: string
                format: binary
        "400":
          description: Invalid date range.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /leads/report.csv:
    get:
      summary: Export lead report as CSV
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: partner_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Optional partner filter.
        - name: start_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Inclusive start date (UTC).
        - name: end_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Inclusive end date (UTC).
        - name: billable_only
          in: query
          required: false
          schema:
            type: boolean
            default: true
          description: When true (default), includes only billable (`qualified`) leads unless `statuses` is explicitly provided.
        - name: statuses
          in: query
          required: false
          schema:
            type: array
            items:
              $ref: "#/components/schemas/LeadStatus"
          style: form
          explode: true
          description: Optional explicit status filter (overrides `billable_only` behavior).
      responses:
        "200":
          description: CSV report for billing/export.
          content:
            text/csv:
              schema:
                type: string
                format: binary
        "400":
          description: Invalid date range.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /investor/seed-readiness:
    get:
      summary: Get seed-readiness KPI snapshot for investor tracking
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: period_months
          in: query
          required: false
          schema:
            type: integer
            minimum: 3
            maximum: 24
            default: 6
          description: Monthly history length used for MRR trend analysis.
      responses:
        "200":
          description: Seed-readiness KPI snapshot.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SeedReadinessResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /investor/marketing-spend:
    post:
      summary: Ingest monthly marketing spend and acquired-customer data
      tags:
        - Monetization
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MarketingSpendIngestRequest"
      responses:
        "201":
          description: Marketing spend entry recorded.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MarketingSpendIngestResponse"
        "400":
          description: Invalid payload.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /investor/unit-economics:
    get:
      summary: Get unit-economics snapshot with seed financial gate checks
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: period_months
          in: query
          required: false
          schema:
            type: integer
            minimum: 3
            maximum: 24
            default: 6
        - name: as_of_date
          in: query
          required: false
          schema:
            type: string
            format: date
      responses:
        "200":
          description: Unit economics and seed financial gate status.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UnitEconomicsResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /investor/nps/responses:
    post:
      summary: Submit in-product NPS feedback response
      tags:
        - Monetization
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NPSSubmissionRequest"
      responses:
        "201":
          description: NPS response accepted.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NPSSubmissionResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /investor/nps/trend:
    get:
      summary: Get monthly NPS trend for investor reporting
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: period_months
          in: query
          required: false
          schema:
            type: integer
            minimum: 3
            maximum: 24
            default: 6
          description: Number of months included in trend.
        - name: as_of_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Optional snapshot date for backtesting trend calculations.
      responses:
        "200":
          description: Monthly and overall NPS trend snapshot.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NPSTrendResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /investor/pmf-evidence:
    get:
      summary: Get PMF activation and 30/60/90 retention cohorts
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: cohort_months
          in: query
          required: false
          schema:
            type: integer
            minimum: 3
            maximum: 24
            default: 6
          description: Number of monthly cohorts included in PMF evidence snapshot.
        - name: activation_window_days
          in: query
          required: false
          schema:
            type: integer
            minimum: 7
            maximum: 60
            default: 30
          description: Activation window measured from first-seen user activity.
        - name: as_of_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Optional snapshot date for backtesting PMF trend calculations.
      responses:
        "200":
          description: PMF evidence snapshot with activation and retention cohorts.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PMFEvidenceResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /investor/pmf-gate:
    get:
      summary: Evaluate PMF gate status against configured thresholds
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: cohort_months
          in: query
          required: false
          schema:
            type: integer
            minimum: 3
            maximum: 24
            default: 6
        - name: activation_window_days
          in: query
          required: false
          schema:
            type: integer
            minimum: 7
            maximum: 60
            default: 30
        - name: nps_period_months
          in: query
          required: false
          schema:
            type: integer
            minimum: 3
            maximum: 24
            default: 6
        - name: as_of_date
          in: query
          required: false
          schema:
            type: string
            format: date
      responses:
        "200":
          description: PMF gate evaluation with criterion-level pass/fail status.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PMFGateStatusResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /investor/snapshot/export:
    get:
      summary: Export combined investor snapshot (JSON or CSV)
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: format
          in: query
          required: false
          schema:
            type: string
            enum:
              - json
              - csv
            default: json
        - name: seed_period_months
          in: query
          required: false
          schema:
            type: integer
            minimum: 3
            maximum: 24
            default: 6
        - name: unit_econ_period_months
          in: query
          required: false
          schema:
            type: integer
            minimum: 3
            maximum: 24
            default: 6
        - name: cohort_months
          in: query
          required: false
          schema:
            type: integer
            minimum: 3
            maximum: 24
            default: 6
        - name: activation_window_days
          in: query
          required: false
          schema:
            type: integer
            minimum: 7
            maximum: 60
            default: 30
        - name: nps_period_months
          in: query
          required: false
          schema:
            type: integer
            minimum: 3
            maximum: 24
            default: 6
        - name: as_of_date
          in: query
          required: false
          schema:
            type: string
            format: date
      responses:
        "200":
          description: Combined investor snapshot.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InvestorSnapshotExportResponse"
            text/csv:
              schema:
                type: string
                format: binary
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /leads/{lead_id}/status:
    patch:
      summary: Update handoff lead lifecycle status
      tags:
        - Monetization
      security:
        - bearerAuth: []
      parameters:
        - name: lead_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LeadStatusUpdateRequest"
      responses:
        "200":
          description: Lead status updated successfully.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LeadStatusUpdateResponse"
        "404":
          description: Lead not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Invalid status transition.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing or invalid bearer token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Insufficient permissions (requires billing scope/role).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  schemas:
    LeadStatus:
      type: string
      enum:
        - initiated
        - qualified
        - rejected
        - converted

    Partner:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: SafeFuture Financial Advisors
        description:
          type: string
          example: Independent financial advisors regulated by the FCA.
        services_offered:
          type: array
          items:
            type: string
          example:
            - pension_advice
            - investment_management
        website:
          type: string
          format: uri
          example: https://www.safefuture.example.com
        qualified_lead_fee_gbp:
          type: number
          format: float
          example: 18.0
        converted_lead_fee_gbp:
          type: number
          format: float
          example: 55.0
      required:
        - id
        - name
        - description
        - services_offered
        - website
        - qualified_lead_fee_gbp
        - converted_lead_fee_gbp

    HandoffResponse:
      type: object
      properties:
        message:
          type: string
          example: Handoff to SafeFuture Financial Advisors initiated.
        lead_id:
          type: string
          format: uuid
        audit_event_id:
          type: string
          nullable: true
          example: 1473f17b-56e9-43e9-b8d8-3cd5a53efed2
        duplicated:
          type: boolean
          example: false
      required:
        - message
        - lead_id
        - duplicated

    LeadReportByPartner:
      type: object
      properties:
        partner_id:
          type: string
          format: uuid
        partner_name:
          type: string
          example: HomePath Mortgages
        leads_count:
          type: integer
          example: 12
        unique_users:
          type: integer
          example: 10
      required:
        - partner_id
        - partner_name
        - leads_count
        - unique_users

    LeadReportResponse:
      type: object
      properties:
        period_start:
          type: string
          format: date
          nullable: true
        period_end:
          type: string
          format: date
          nullable: true
        total_leads:
          type: integer
          example: 42
        unique_users:
          type: integer
          example: 35
        by_partner:
          type: array
          items:
            $ref: "#/components/schemas/LeadReportByPartner"
      required:
        - total_leads
        - unique_users
        - by_partner

    BillingReportByPartner:
      type: object
      properties:
        partner_id:
          type: string
          format: uuid
        partner_name:
          type: string
          example: SafeFuture Financial Advisors
        qualified_leads:
          type: integer
          example: 12
        converted_leads:
          type: integer
          example: 3
        unique_users:
          type: integer
          example: 10
        qualified_lead_fee_gbp:
          type: number
          format: float
          example: 18.0
        converted_lead_fee_gbp:
          type: number
          format: float
          example: 55.0
        amount_gbp:
          type: number
          format: float
          example: 381.0
      required:
        - partner_id
        - partner_name
        - qualified_leads
        - converted_leads
        - unique_users
        - qualified_lead_fee_gbp
        - converted_lead_fee_gbp
        - amount_gbp

    BillingReportResponse:
      type: object
      properties:
        period_start:
          type: string
          format: date
          nullable: true
        period_end:
          type: string
          format: date
          nullable: true
        currency:
          type: string
          example: GBP
        total_leads:
          type: integer
          example: 15
        qualified_leads:
          type: integer
          example: 12
        converted_leads:
          type: integer
          example: 3
        unique_users:
          type: integer
          example: 10
        total_amount_gbp:
          type: number
          format: float
          example: 381.0
        by_partner:
          type: array
          items:
            $ref: "#/components/schemas/BillingReportByPartner"
      required:
        - currency
        - total_leads
        - qualified_leads
        - converted_leads
        - unique_users
        - total_amount_gbp
        - by_partner

    SeedMRRPoint:
      type: object
      properties:
        month:
          type: string
          example: "2026-02"
        mrr_gbp:
          type: number
          format: float
          example: 1234.56
      required:
        - month
        - mrr_gbp

    SeedReadinessResponse:
      type: object
      properties:
        generated_at:
          type: string
          format: date-time
        period_months:
          type: integer
          example: 6
        current_month_mrr_gbp:
          type: number
          format: float
        previous_month_mrr_gbp:
          type: number
          format: float
        mrr_growth_percent:
          type: number
          format: float
        rolling_3_month_avg_mrr_gbp:
          type: number
          format: float
        paid_invoice_rate_percent:
          type: number
          format: float
        active_invoice_count:
          type: integer
        leads_last_90d:
          type: integer
        qualified_last_90d:
          type: integer
        converted_last_90d:
          type: integer
        qualification_rate_percent:
          type: number
          format: float
        conversion_rate_percent:
          type: number
          format: float
        readiness_score_percent:
          type: number
          format: float
        readiness_band:
          type: string
          enum:
            - early
            - progressing
            - investable
        next_actions:
          type: array
          items:
            type: string
        monthly_mrr_series:
          type: array
          items:
            $ref: "#/components/schemas/SeedMRRPoint"
      required:
        - generated_at
        - period_months
        - current_month_mrr_gbp
        - previous_month_mrr_gbp
        - mrr_growth_percent
        - rolling_3_month_avg_mrr_gbp
        - paid_invoice_rate_percent
        - active_invoice_count
        - leads_last_90d
        - qualified_last_90d
        - converted_last_90d
        - qualification_rate_percent
        - conversion_rate_percent
        - readiness_score_percent
        - readiness_band
        - next_actions
        - monthly_mrr_series

    PMFMonthlyCohortPoint:
      type: object
      properties:
        cohort_month:
          type: string
          example: "2026-01"
        new_users:
          type: integer
        activated_users:
          type: integer
        activation_rate_percent:
          type: number
          format: float
        eligible_users_30d:
          type: integer
        retained_users_30d:
          type: integer
        retention_rate_30d_percent:
          type: number
          format: float
        eligible_users_60d:
          type: integer
        retained_users_60d:
          type: integer
        retention_rate_60d_percent:
          type: number
          format: float
        eligible_users_90d:
          type: integer
        retained_users_90d:
          type: integer
        retention_rate_90d_percent:
          type: number
          format: float
      required:
        - cohort_month
        - new_users
        - activated_users
        - activation_rate_percent
        - eligible_users_30d
        - retained_users_30d
        - retention_rate_30d_percent
        - eligible_users_60d
        - retained_users_60d
        - retention_rate_60d_percent
        - eligible_users_90d
        - retained_users_90d
        - retention_rate_90d_percent

    PMFEvidenceResponse:
      type: object
      properties:
        generated_at:
          type: string
          format: date-time
        as_of_date:
          type: string
          format: date
        cohort_months:
          type: integer
        activation_window_days:
          type: integer
        total_new_users:
          type: integer
        activated_users:
          type: integer
        activation_rate_percent:
          type: number
          format: float
        eligible_users_30d:
          type: integer
        retained_users_30d:
          type: integer
        retention_rate_30d_percent:
          type: number
          format: float
        eligible_users_60d:
          type: integer
        retained_users_60d:
          type: integer
        retention_rate_60d_percent:
          type: number
          format: float
        eligible_users_90d:
          type: integer
        retained_users_90d:
          type: integer
        retention_rate_90d_percent:
          type: number
          format: float
        pmf_band:
          type: string
          enum:
            - early
            - emerging
            - pmf_confirmed
        notes:
          type: array
          items:
            type: string
        monthly_cohorts:
          type: array
          items:
            $ref: "#/components/schemas/PMFMonthlyCohortPoint"
      required:
        - generated_at
        - as_of_date
        - cohort_months
        - activation_window_days
        - total_new_users
        - activated_users
        - activation_rate_percent
        - eligible_users_30d
        - retained_users_30d
        - retention_rate_30d_percent
        - eligible_users_60d
        - retained_users_60d
        - retention_rate_60d_percent
        - eligible_users_90d
        - retained_users_90d
        - retention_rate_90d_percent
        - pmf_band
        - notes
        - monthly_cohorts

    PMFGateStatusResponse:
      type: object
      properties:
        generated_at:
          type: string
          format: date-time
        gate_name:
          type: string
          enum:
            - seed_pmf_gate_v1
        activation_rate_percent:
          type: number
          format: float
        retention_rate_90d_percent:
          type: number
          format: float
        overall_nps_score:
          type: number
          format: float
        eligible_users_90d:
          type: integer
        total_nps_responses:
          type: integer
        required_activation_rate_percent:
          type: number
          format: float
        required_retention_rate_90d_percent:
          type: number
          format: float
        required_overall_nps_score:
          type: number
          format: float
        required_min_eligible_users_90d:
          type: integer
        required_min_nps_responses:
          type: integer
        activation_passed:
          type: boolean
        retention_passed:
          type: boolean
        nps_passed:
          type: boolean
        sample_size_passed:
          type: boolean
        gate_passed:
          type: boolean
        summary:
          type: string
        next_actions:
          type: array
          items:
            type: string
      required:
        - generated_at
        - gate_name
        - activation_rate_percent
        - retention_rate_90d_percent
        - overall_nps_score
        - eligible_users_90d
        - total_nps_responses
        - required_activation_rate_percent
        - required_retention_rate_90d_percent
        - required_overall_nps_score
        - required_min_eligible_users_90d
        - required_min_nps_responses
        - activation_passed
        - retention_passed
        - nps_passed
        - sample_size_passed
        - gate_passed
        - summary
        - next_actions

    MarketingSpendIngestRequest:
      type: object
      properties:
        month_start:
          type: string
          format: date
        channel:
          type: string
          minLength: 2
          maxLength: 64
        spend_gbp:
          type: number
          format: float
          minimum: 0
        acquired_customers:
          type: integer
          minimum: 0
      required:
        - month_start
        - channel
        - spend_gbp
        - acquired_customers

    MarketingSpendIngestResponse:
      type: object
      properties:
        entry_id:
          type: string
          format: uuid
        month_start:
          type: string
          format: date
        channel:
          type: string
        spend_gbp:
          type: number
          format: float
        acquired_customers:
          type: integer
        created_at:
          type: string
          format: date-time
        message:
          type: string
      required:
        - entry_id
        - month_start
        - channel
        - spend_gbp
        - acquired_customers
        - created_at
        - message

    UnitEconomicsMonthlyPoint:
      type: object
      properties:
        month:
          type: string
        mrr_gbp:
          type: number
          format: float
        previous_month_mrr_gbp:
          type: number
          format: float
        churn_rate_percent:
          type: number
          format: float
        expansion_rate_percent:
          type: number
          format: float
        marketing_spend_gbp:
          type: number
          format: float
        acquired_customers:
          type: integer
        cac_gbp:
          type: number
          format: float
          nullable: true
      required:
        - month
        - mrr_gbp
        - previous_month_mrr_gbp
        - churn_rate_percent
        - expansion_rate_percent
        - marketing_spend_gbp
        - acquired_customers

    UnitEconomicsResponse:
      type: object
      properties:
        generated_at:
          type: string
          format: date-time
        as_of_date:
          type: string
          format: date
        period_months:
          type: integer
        current_month_mrr_gbp:
          type: number
          format: float
        rolling_3_month_avg_mrr_gbp:
          type: number
          format: float
        mrr_growth_percent:
          type: number
          format: float
        mrr_stability_percent:
          type: number
          format: float
        mrr_stability_band:
          type: string
          enum:
            - stable
            - variable
            - volatile
        monthly_churn_rate_percent:
          type: number
          format: float
        monthly_expansion_rate_percent:
          type: number
          format: float
        average_cac_gbp:
          type: number
          format: float
          nullable: true
        estimated_ltv_gbp:
          type: number
          format: float
          nullable: true
        ltv_cac_ratio:
          type: number
          format: float
          nullable: true
        required_mrr_gbp:
          type: number
          format: float
        required_max_monthly_churn_percent:
          type: number
          format: float
        required_min_ltv_cac_ratio:
          type: number
          format: float
        mrr_gate_passed:
          type: boolean
        churn_gate_passed:
          type: boolean
        ltv_cac_gate_passed:
          type: boolean
        seed_gate_passed:
          type: boolean
        next_actions:
          type: array
          items:
            type: string
        monthly_points:
          type: array
          items:
            $ref: "#/components/schemas/UnitEconomicsMonthlyPoint"
      required:
        - generated_at
        - as_of_date
        - period_months
        - current_month_mrr_gbp
        - rolling_3_month_avg_mrr_gbp
        - mrr_growth_percent
        - mrr_stability_percent
        - mrr_stability_band
        - monthly_churn_rate_percent
        - monthly_expansion_rate_percent
        - required_mrr_gbp
        - required_max_monthly_churn_percent
        - required_min_ltv_cac_ratio
        - mrr_gate_passed
        - churn_gate_passed
        - ltv_cac_gate_passed
        - seed_gate_passed
        - next_actions
        - monthly_points

    InvestorSnapshotExportResponse:
      type: object
      properties:
        generated_at:
          type: string
          format: date-time
        as_of_date:
          type: string
          format: date
        seed_readiness:
          $ref: "#/components/schemas/SeedReadinessResponse"
        pmf_evidence:
          $ref: "#/components/schemas/PMFEvidenceResponse"
        nps_trend:
          $ref: "#/components/schemas/NPSTrendResponse"
        pmf_gate:
          $ref: "#/components/schemas/PMFGateStatusResponse"
        unit_economics:
          $ref: "#/components/schemas/UnitEconomicsResponse"
      required:
        - generated_at
        - as_of_date
        - seed_readiness
        - pmf_evidence
        - nps_trend
        - pmf_gate
        - unit_economics

    NPSSubmissionRequest:
      type: object
      properties:
        score:
          type: integer
          minimum: 0
          maximum: 10
        feedback:
          type: string
          nullable: true
          maxLength: 1000
        context_tag:
          type: string
          nullable: true
          maxLength: 64
          default: dashboard
        locale:
          type: string
          nullable: true
          maxLength: 16
      required:
        - score

    NPSSubmissionResponse:
      type: object
      properties:
        response_id:
          type: string
          format: uuid
        score_band:
          type: string
          enum:
            - promoter
            - passive
            - detractor
        submitted_at:
          type: string
          format: date-time
        message:
          type: string
      required:
        - response_id
        - score_band
        - submitted_at
        - message

    NPSMonthlyTrendPoint:
      type: object
      properties:
        month:
          type: string
          example: "2026-02"
        responses_count:
          type: integer
        promoters_count:
          type: integer
        passives_count:
          type: integer
        detractors_count:
          type: integer
        nps_score:
          type: number
          format: float
      required:
        - month
        - responses_count
        - promoters_count
        - passives_count
        - detractors_count
        - nps_score

    NPSTrendResponse:
      type: object
      properties:
        generated_at:
          type: string
          format: date-time
        period_months:
          type: integer
        total_responses:
          type: integer
        promoters_count:
          type: integer
        passives_count:
          type: integer
        detractors_count:
          type: integer
        overall_nps_score:
          type: number
          format: float
        monthly_trend:
          type: array
          items:
            $ref: "#/components/schemas/NPSMonthlyTrendPoint"
        note:
          type: string
      required:
        - generated_at
        - period_months
        - total_responses
        - promoters_count
        - passives_count
        - detractors_count
        - overall_nps_score
        - monthly_trend
        - note

    PartnerPricingUpdateRequest:
      type: object
      properties:
        qualified_lead_fee_gbp:
          type: number
          format: float
          minimum: 0
        converted_lead_fee_gbp:
          type: number
          format: float
          minimum: 0
      required:
        - qualified_lead_fee_gbp
        - converted_lead_fee_gbp

    LeadListItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
        partner_id:
          type: string
          format: uuid
        partner_name:
          type: string
        status:
          $ref: "#/components/schemas/LeadStatus"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required:
        - id
        - user_id
        - partner_id
        - partner_name
        - status
        - created_at
        - updated_at

    LeadListResponse:
      type: object
      properties:
        total:
          type: integer
          example: 124
        items:
          type: array
          items:
            $ref: "#/components/schemas/LeadListItem"
      required:
        - total
        - items

    BillingInvoiceStatus:
      type: string
      enum:
        - generated
        - issued
        - paid
        - void

    SelfEmployedInvoiceStatus:
      type: string
      enum:
        - draft
        - issued
        - paid
        - overdue
        - void

    AccountingExportTarget:
      type: string
      enum:
        - xero
        - quickbooks

    SelfEmployedInvoiceLineInput:
      type: object
      properties:
        description:
          type: string
          minLength: 1
          maxLength: 500
        quantity:
          type: number
          format: float
          exclusiveMinimum: 0
        unit_price_gbp:
          type: number
          format: float
          minimum: 0
      required:
        - description
        - quantity
        - unit_price_gbp

    SelfEmployedInvoiceCreateRequest:
      type: object
      properties:
        customer_name:
          type: string
          minLength: 2
          maxLength: 180
        customer_email:
          type: string
          maxLength: 255
          nullable: true
        customer_address:
          type: string
          maxLength: 500
          nullable: true
        issue_date:
          type: string
          format: date
          nullable: true
        due_date:
          type: string
          format: date
          nullable: true
        currency:
          type: string
          minLength: 3
          maxLength: 3
          default: GBP
        tax_rate_percent:
          type: number
          format: float
          minimum: 0
          maximum: 100
          default: 0
        notes:
          type: string
          maxLength: 1000
          nullable: true
        lines:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/SelfEmployedInvoiceLineInput"
      required:
        - customer_name
        - lines

    SelfEmployedInvoiceLine:
      type: object
      properties:
        id:
          type: string
          format: uuid
        description:
          type: string
        quantity:
          type: number
          format: float
        unit_price_gbp:
          type: number
          format: float
        line_total_gbp:
          type: number
          format: float
      required:
        - id
        - description
        - quantity
        - unit_price_gbp
        - line_total_gbp

    SelfEmployedInvoiceSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        invoice_number:
          type: string
        customer_name:
          type: string
        issue_date:
          type: string
          format: date
        due_date:
          type: string
          format: date
        currency:
          type: string
        status:
          $ref: "#/components/schemas/SelfEmployedInvoiceStatus"
        total_amount_gbp:
          type: number
          format: float
        created_at:
          type: string
          format: date-time
      required:
        - id
        - invoice_number
        - customer_name
        - issue_date
        - due_date
        - currency
        - status
        - total_amount_gbp
        - created_at

    SelfEmployedInvoiceDetail:
      allOf:
        - $ref: "#/components/schemas/SelfEmployedInvoiceSummary"
        - type: object
          properties:
            customer_email:
              type: string
              nullable: true
            customer_address:
              type: string
              nullable: true
            subtotal_gbp:
              type: number
              format: float
            tax_rate_percent:
              type: number
              format: float
            tax_amount_gbp:
              type: number
              format: float
            notes:
              type: string
              nullable: true
            updated_at:
              type: string
              format: date-time
            lines:
              type: array
              items:
                $ref: "#/components/schemas/SelfEmployedInvoiceLine"
          required:
            - subtotal_gbp
            - tax_rate_percent
            - tax_amount_gbp
            - updated_at
            - lines

    SelfEmployedInvoiceListResponse:
      type: object
      properties:
        total:
          type: integer
        items:
          type: array
          items:
            $ref: "#/components/schemas/SelfEmployedInvoiceSummary"
      required:
        - total
        - items

    SelfEmployedInvoiceStatusUpdateRequest:
      type: object
      properties:
        status:
          $ref: "#/components/schemas/SelfEmployedInvoiceStatus"
      required:
        - status

    BillingInvoiceGenerateRequest:
      type: object
      properties:
        partner_id:
          type: string
          format: uuid
          nullable: true
        start_date:
          type: string
          format: date
          nullable: true
        end_date:
          type: string
          format: date
          nullable: true
        statuses:
          type: array
          items:
            $ref: "#/components/schemas/LeadStatus"

    BillingInvoiceLine:
      type: object
      properties:
        partner_id:
          type: string
          format: uuid
        partner_name:
          type: string
        qualified_leads:
          type: integer
        converted_leads:
          type: integer
        unique_users:
          type: integer
        qualified_lead_fee_gbp:
          type: number
          format: float
        converted_lead_fee_gbp:
          type: number
          format: float
        amount_gbp:
          type: number
          format: float
      required:
        - partner_id
        - partner_name
        - qualified_leads
        - converted_leads
        - unique_users
        - qualified_lead_fee_gbp
        - converted_lead_fee_gbp
        - amount_gbp

    BillingInvoiceSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        invoice_number:
          type: string
          example: INV-202602-000123
        period_start:
          type: string
          format: date
          nullable: true
        period_end:
          type: string
          format: date
          nullable: true
        due_date:
          type: string
          format: date
        currency:
          type: string
          example: GBP
        status:
          $ref: "#/components/schemas/BillingInvoiceStatus"
        total_amount_gbp:
          type: number
          format: float
        created_at:
          type: string
          format: date-time
      required:
        - id
        - invoice_number
        - due_date
        - currency
        - status
        - total_amount_gbp
        - created_at

    BillingInvoiceDetail:
      allOf:
        - $ref: "#/components/schemas/BillingInvoiceSummary"
        - type: object
          properties:
            generated_by_user_id:
              type: string
            partner_id:
              type: string
              format: uuid
              nullable: true
            statuses:
              type: array
              items:
                $ref: "#/components/schemas/LeadStatus"
            updated_at:
              type: string
              format: date-time
            lines:
              type: array
              items:
                $ref: "#/components/schemas/BillingInvoiceLine"
          required:
            - generated_by_user_id
            - statuses
            - updated_at
            - lines

    BillingInvoiceListResponse:
      type: object
      properties:
        total:
          type: integer
        items:
          type: array
          items:
            $ref: "#/components/schemas/BillingInvoiceSummary"
      required:
        - total
        - items

    BillingInvoiceStatusUpdateRequest:
      type: object
      properties:
        status:
          $ref: "#/components/schemas/BillingInvoiceStatus"
      required:
        - status

    LeadStatusUpdateRequest:
      type: object
      properties:
        status:
          $ref: "#/components/schemas/LeadStatus"
      required:
        - status

    LeadStatusUpdateResponse:
      type: object
      properties:
        lead_id:
          type: string
          format: uuid
        status:
          $ref: "#/components/schemas/LeadStatus"
        updated_at:
          type: string
          format: date-time
      required:
        - lead_id
        - status
        - updated_at

    ErrorResponse:
      type: object
      properties:
        detail:
          type: string
      required:
        - detail

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
