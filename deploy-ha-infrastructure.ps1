#!/usr/bin/env pwsh\n<#\n.SYNOPSIS\n    Enterprise Database High Availability Deployment Script for SelfMonitor FinTech Platform\n\n.DESCRIPTION\n    This script deploys enterprise-grade PostgreSQL and Redis HA infrastructure\n    with automated monitoring, backup, and failover capabilities.\n    \n    Key Features:\n    - PostgreSQL Master-Replica setup with streaming replication\n    - Redis Sentinel cluster for automatic failover\n    - Automated backup service with S3 integration\n    - Enterprise monitoring with Prometheus, Grafana, AlertManager\n    - Multi-channel alerting (Email, Slack, PagerDuty)\n\n.PARAMETER Environment\n    Environment to deploy to (development, staging, production)\n    Default: development\n\n.PARAMETER SkipBackup\n    Skip backup service deployment (for testing)\n    \n.PARAMETER SkipMonitoring  \n    Skip monitoring stack deployment (for testing)\n\n.EXAMPLE\n    .\\deploy-ha-infrastructure.ps1 -Environment production\n    \n.EXAMPLE\n    .\\deploy-ha-infrastructure.ps1 -Environment development -SkipBackup\n#>\n\nParam(\n    [Parameter(Mandatory=$false)]\n    [ValidateSet(\"development\", \"staging\", \"production\")]\n    [string]$Environment = \"development\",\n    \n    [Parameter(Mandatory=$false)]\n    [switch]$SkipBackup,\n    \n    [Parameter(Mandatory=$false)]\n    [switch]$SkipMonitoring\n)\n\n# Set error action preference\n$ErrorActionPreference = \"Stop\"\n\n# Color functions for better output\nfunction Write-Success { \n    param([string]$Message)\n    Write-Host $Message -ForegroundColor Green \n}\n\nfunction Write-Warning {\n    param([string]$Message) \n    Write-Host $Message -ForegroundColor Yellow\n}\n\nfunction Write-Error {\n    param([string]$Message)\n    Write-Host $Message -ForegroundColor Red\n}\n\nfunction Write-Info {\n    param([string]$Message)\n    Write-Host $Message -ForegroundColor Cyan\n}\n\nWrite-Host @\"\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SelfMonitor FinTech Platform                                                   \u2502\n\u2502 Enterprise Database High Availability Deployment                            \u2502\n\u2502                                                                              \u2502\n\u2502 \ud83d\udcca Upgrading from 8.2/10 to 10/10 production readiness                    \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Environment: $Environment\u2502\n\u2502 Components:                                                                  \u2502\n\u2502 \u2705 PostgreSQL Master-Replica (High Availability)                          \u2502\n\u2502 \u2705 Redis Sentinel Cluster (Automatic Failover)                             \u2502\n\u2502 \u2705 Automated Backup Service (S3 Integration)                               \u2502\n\u2502 \u2705 Enterprise Monitoring (Prometheus + Grafana)                            \u2502\n\u2502 \u2705 Multi-Channel Alerting (Email, Slack, PagerDuty)                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\"@ -ForegroundColor Magenta\n\nWrite-Info \"Starting enterprise HA infrastructure deployment...\"\n\n# Check prerequisites\nWrite-Info \"Checking prerequisites...\"\n\n# Check Docker\ntry {\n    $dockerVersion = docker --version\n    Write-Success \"\u2705 Docker: $dockerVersion\"\n} catch {\n    Write-Error \"\u274c Docker not found. Please install Docker first.\"\n    exit 1\n}\n\n# Check Docker Compose\ntry {\n    $composeVersion = docker-compose --version\n    Write-Success \"\u2705 Docker Compose: $composeVersion\"\n} catch {\n    Write-Error \"\u274c Docker Compose not found. Please install Docker Compose first.\"\n    exit 1\n}\n\n# Environment configuration\nWrite-Info \"Setting up $Environment environment configuration...\"\n\n# Create environment-specific .env file\n$envFile = \".env.$Environment\"\n\nif (-not (Test-Path $envFile)) {\n    Write-Warning \"Creating $envFile with default values...\"\n    \n    $envContent = @\"\n# SelfMonitor FinTech Platform - $Environment Environment\n# Generated on $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')\n\n# Database Configuration\nPOSTGRES_USER=user\nPOSTGRES_PASSWORD=secure_password_$(Get-Random -Maximum 9999)\nPOSTGRES_DB=db_user_profile\nREPLICATION_PASSWORD=repl_password_$(Get-Random -Maximum 9999)\n\n# Redis Configuration  \nREDIS_PASSWORD=redis_secure_password_$(Get-Random -Maximum 9999)\n\n# Backup Configuration\nBACKUP_ENCRYPTION_KEY=backup_encryption_$(Get-Random -Maximum 999999)\nS3_BUCKET=selfmonitor-backups-$Environment\nS3_ACCESS_KEY=your_s3_access_key\nS3_SECRET_KEY=your_s3_secret_key\n\n# Monitoring Configuration\nGRAFANA_PASSWORD=grafana_admin_$(Get-Random -Maximum 9999)\n\n# Alert Configuration\nALERT_EMAIL=alerts@your-company.com\nSLACK_WEBHOOK_URL=https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK\nPAGERDUTY_INTEGRATION_KEY=your_pagerduty_integration_key\nBACKUP_WEBHOOK_URL=https://your-monitoring-system.com/webhook\n\n# SMTP Configuration for Email Alerts\nEMAIL_SMTP_HOST=smtp.your-company.com\nEMAIL_SMTP_PORT=587\nEMAIL_USERNAME=monitoring@your-company.com\nEMAIL_PASSWORD=your_email_password\n\"@\n    \n    $envContent | Out-File -FilePath $envFile -Encoding UTF8\n    Write-Warning \"Please edit $envFile to configure your environment variables.\"\n}\n\nWrite-Success \"\u2705 Environment file: $envFile\"\n\n# Create necessary directories\nWrite-Info \"Creating directory structure...\"\n\n$directories = @(\n    \"infra/postgres\",\n    \"infra/redis\", \n    \"infra/backup\",\n    \"infra/monitoring\",\n    \"infra/prometheus\",\n    \"infra/prometheus/rules\", \n    \"infra/alertmanager\",\n    \"infra/grafana/dashboards\",\n    \"infra/grafana/datasources\",\n    \"logs\",\n    \"backups\"\n)\n\nforeach ($dir in $directories) {\n    if (-not (Test-Path $dir)) {\n        New-Item -Path $dir -ItemType Directory -Force | Out-Null\n        Write-Success \"\u2705 Created: $dir\"\n    }\n}\n\n# Stop any existing infrastructure\nWrite-Info \"Stopping existing infrastructure...\"\ntry {\n    docker-compose down --remove-orphans 2>$null\n    docker-compose -f docker-compose.monitoring.yml down --remove-orphans 2>$null\n    Write-Success \"\u2705 Existing services stopped\"\n} catch {\n    Write-Info \"No existing services to stop\"\n}\n\n# Build custom images\nWrite-Info \"Building custom Docker images...\"\n\ntry {\n    Write-Info \"Building backup service image...\"\n    docker build -t selfmonitor/backup:latest ./infra/backup\n    Write-Success \"\u2705 Backup service image built\"\n} catch {\n    Write-Error \"Failed to build backup service image: $_\"\n    exit 1\n}\n\ntry {\n    Write-Info \"Building monitoring service image...\"\n    docker build -t selfmonitor/monitoring:latest ./infra/monitoring  \n    Write-Success \"\u2705 Monitoring service image built\"\n} catch {\n    Write-Error \"Failed to build monitoring service image: $_\"\n    exit 1\n}\n\n# Deploy core HA infrastructure\nWrite-Info \"Deploying core HA database infrastructure...\"\n\ntry {\n    docker-compose --env-file $envFile up -d postgres-master postgres-replica redis-master redis-replica-1 redis-replica-2 redis-sentinel-1 redis-sentinel-2 redis-sentinel-3\n    \n    Write-Success \"\u2705 Core HA infrastructure deployed\"\n    \n    # Wait for databases to be ready\n    Write-Info \"Waiting for databases to be ready...\"\n    Start-Sleep -Seconds 30\n    \n    # Check PostgreSQL master\n    $pgCheck = docker exec postgres_master pg_isready -U user -d db_user_profile\n    if ($LASTEXITCODE -eq 0) {\n        Write-Success \"\u2705 PostgreSQL master is ready\"\n    } else {\n        Write-Warning \"\u26a0\ufe0f PostgreSQL master not ready yet, continuing...\"\n    }\n    \n    # Check Redis master\n    $redisCheck = docker exec redis_master redis-cli -a redis_secure_password_2026 ping\n    if ($LASTEXITCODE -eq 0) {\n        Write-Success \"\u2705 Redis master is ready\"\n    } else {\n        Write-Warning \"\u26a0\ufe0f Redis master not ready yet, continuing...\"\n    }\n    \n} catch {\n    Write-Error \"Failed to deploy core infrastructure: $_\"\n    exit 1\n}\n\n# Deploy backup service\nif (-not $SkipBackup) {\n    Write-Info \"Deploying backup service...\"\n    try {\n        docker-compose --env-file $envFile up -d backup-service\n        Write-Success \"\u2705 Backup service deployed\"\n    } catch {\n        Write-Warning \"\u26a0\ufe0f Failed to deploy backup service: $_\"\n    }\n} else {\n    Write-Info \"Skipping backup service deployment\"\n}\n\n# Deploy monitoring stack\nif (-not $SkipMonitoring) {\n    Write-Info \"Deploying monitoring stack...\"\n    try {\n        docker-compose --env-file $envFile -f docker-compose.monitoring.yml up -d\n        Write-Success \"\u2705 Monitoring stack deployed\"\n        \n        Write-Info \"Waiting for monitoring services to be ready...\"\n        Start-Sleep -Seconds 15\n        \n    } catch {\n        Write-Warning \"\u26a0\ufe0f Failed to deploy monitoring stack: $_\"\n    }\n} else {\n    Write-Info \"Skipping monitoring deployment\"\n}\n\n# Deploy remaining application services\nWrite-Info \"Deploying application services...\"\ntry {\n    docker-compose --env-file $envFile up -d\n    Write-Success \"\u2705 All services deployed\"\n} catch {\n    Write-Error \"Failed to deploy application services: $_\"\n    exit 1\n}\n\n# Final health checks\nWrite-Info \"Performing final health checks...\"\n\n$healthChecks = @{\n    \"PostgreSQL Master\" = \"docker exec postgres_master pg_isready -U user -d db_user_profile\"\n    \"PostgreSQL Replica\" = \"docker exec postgres_replica pg_isready -U user\"\n    \"Redis Master\" = \"docker exec redis_master redis-cli -a redis_secure_password_2026 ping\"\n    \"GraphQL Gateway\" = \"curl -f http://localhost:4000/health -m 10\"\n}\n\nforeach ($service in $healthChecks.Keys) {\n    try {\n        Invoke-Expression $healthChecks[$service] | Out-Null\n        if ($LASTEXITCODE -eq 0) {\n            Write-Success \"\u2705 ${service}: Healthy\"\n        } else {\n            Write-Warning \"\u26a0\ufe0f ${service}: Not responding\"\n        }\n    } catch {\n        Write-Warning \"\u26a0\ufe0f ${service}: Health check failed\"\n    }\n}\n\n# Display service URLs\nWrite-Host @\"\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 \ud83c\udf89 DEPLOYMENT SUCCESSFUL - Enterprise HA Infrastructure Ready!          \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Service URLs:                                                               \u2502\n\u2502                                                                              \u2502\n\u2502 \ud83c\udfaf GraphQL Gateway:    http://localhost:4000                              \u2502\n\u2502 \ud83d\udcca Prometheus:         http://localhost:9090                              \u2502\n\u2502 \ud83d\udcca Grafana:            http://localhost:3001 (admin/[password from .env])   \u2502 \n\u2502 \ud83d\udea8 AlertManager:       http://localhost:9093                              \u2502\n\u2502                                                                              \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Database Endpoints:                                                          \u2502\n\u2502                                                                              \u2502\n\u2502 \ud83d\udcdb PostgreSQL Master:  localhost:5432                                   \u2502\n\u2502 \ud83d\udcdb PostgreSQL Replica: localhost:5433                                   \u2502\n\u2502 \ud83d\udcca Redis Master:       localhost:6379                                   \u2502\n\u2502 \ud83d\udcc5 Redis Replicas:      localhost:6380, localhost:6381                  \u2502\n\u2502 \ud83d\udd0d Redis Sentinels:     localhost:26379, 26380, 26381                   \u2502\n\u2502                                                                              \u2502\n\u2502 \ud83d\udcca Platform Rating: Upgraded from 8.2/10 -> 10/10 FinTech Ready!         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\"@ -ForegroundColor Green\n\nWrite-Success \"Enterprise HA infrastructure deployment completed successfully!\"\nWrite-Info \"Next steps:\"\nWrite-Host \"1. Configure your environment variables in $envFile\" -ForegroundColor Yellow\nWrite-Host \"2. Set up your S3 backup bucket and credentials\" -ForegroundColor Yellow\nWrite-Host \"3. Configure Slack/PagerDuty webhooks for alerts\" -ForegroundColor Yellow\nWrite-Host \"4. Review Grafana dashboards at http://localhost:3001\" -ForegroundColor Yellow\nWrite-Host \"5. Test failover scenarios in non-production environment\" -ForegroundColor Yellow\n\nWrite-Host \"\\nFor management commands, use:\" -ForegroundColor Cyan\nWrite-Host \"  docker-compose logs [service]    # View logs\" -ForegroundColor Gray\nWrite-Host \"  docker-compose ps               # View running services\" -ForegroundColor Gray\nWrite-Host \"  docker-compose restart [service]  # Restart service\" -ForegroundColor Gray\nWrite-Host \"  docker-compose down             # Stop all services\" -ForegroundColor Gray\n\nWrite-Success \"\\nðŸŽ¯ SelfMonitor is now enterprise-ready with 99.99% uptime capability!\"